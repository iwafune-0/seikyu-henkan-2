# Phase 1: 要件定義 完了報告

**作業日**: 2025-10-07
**所要時間**: 6時間
**ステータス**: ✅ 完了

---

## 🎯 Phase 1 サマリー

**プロジェクト名**: 月次処理自動化システム
**目的**: 毎月の請求書処理業務（PDF→Excel編集→PDF生成）を自動化し、工数を90%削減する
**完了したステップ**: 10/10 ステップ
**進捗率**: Phase 1完了（全体の10%）

---

## 📦 成果物（5ファイル）

### 1. 📄 docs/requirements.md
- **内容**: 完全な要件定義書（Markdown版）
- **行数**: 612行
- **セクション**: 10章構成
  - プロジェクト概要
  - 成果定義
  - システム要件
  - 機能要件
  - 非機能要件
  - 技術スタック
  - データベース設計
  - 外部サービス
  - セキュリティ要件
  - 開発・デプロイ環境

### 2. 🌐 docs/requirements.html
- **内容**: HTML版要件定義書（視覚的に見やすい形式）
- **特徴**: 目次リンク、カラーコーディング、印刷対応

### 3. 📊 docs/requirements_progress.md
- **内容**: 要件定義進捗記録
- **記載内容**: Step#1〜10の詳細な決定事項、議論の履歴

### 4. 📈 docs/SCOPE_PROGRESS.md
- **内容**: 開発進捗管理表
- **記載内容**:
  - Phase 1-10の進捗状況
  - 全8ページの管理表
  - 実装優先順位

### 5. ⚙️ CLAUDE.md
- **内容**: 開発ルール設定ファイル
- **記載内容**:
  - エンジニアリング姿勢（ケン・トンプソン原則）
  - 型定義同期ルール
  - コーディング規約
  - テストポリシー
  - セキュリティガイドライン

---

## ✅ 完了した10ステップ

### Step#1: 成果定義の確定
- システムの目的と成功指標（定量・定性）を定義
- 定量指標: 処理時間90%削減、エラー事前検知率100%
- 定性指標: 脱属人化、ストレスフリー、トレーサビリティ

### Step#2: 実現可能性調査（技術的検証）
- PDF解析（pdfplumber）の技術検証完了
- Excel編集（openpyxl）の技術検証完了
- 認証機能（Supabase Auth）の技術検証完了
- 無料枠で十分運用可能と確認

### Step#3: 認証・権限設計
- 招待制認証を採用
- 2つのロール（管理者・一般ユーザー）を設計
- Row Level Security（RLS）でデータベースレベルの権限制御

### Step#4: 必要なページリスト作成
- 全8ページ（認証3 + メイン5）の詳細仕様を確定
- P-002（PDF処理実行）: 7つの画面状態、UIフロー詳細化
- P-004（ユーザー管理）: 保護機能（自己編集ブロック、最終管理者保護）
- P-005（取引先設定）: テンプレートExcel管理、処理ルール表示

### Step#5: 技術スタック最終決定
- フロントエンド: React 18 + TypeScript + Vite + Tailwind CSS
- バックエンド: Node.js 20 + Python 3.11
- データベース: Supabase PostgreSQL 15
- デプロイ: AWS Amplify + Lambda Docker Image
- 月額費用: $0（完全無料構成）

### Step#6: 外部API最終決定
- Supabase（データベース + 認証）
- AWS Amplify（フロントエンドホスティング）
- AWS Lambda（バックエンド実行環境）
- 外部APIは使用せず、全て自前実装

### Step#7: 要件定義書の書き出し
- requirements.md（612行）を生成
- requirements.html（ブラウザ表示版）を生成

### Step#8: SCOPE_PROGRESS進捗表挿入
- 基本情報を更新（Phase 1完了、進捗率10%）
- ページ管理表を追加（認証3ページ + メイン5ページ）
- 実装優先順位を記載

### Step#9: CLAUDE.md生成
- Phase 2以降の開発ルール設定ファイルを生成
- 10セクション（姿勢、規約、テスト、セキュリティ等）

### Step#10: ページの深掘り
- 深掘り不要と判断（実装時に調整可能な詳細度）
- 複雑なUI/UX、ビジネスロジックがないため

---

## 🎯 確定した仕様

### システム概要

| 項目 | 内容 |
|------|------|
| **システム名** | 月次処理自動化システム |
| **目的** | 毎月25日～翌月5日の請求書処理業務を自動化（工数90%削減） |
| **対象取引先** | ネクストビッツ様、オフビートワークス様（将来追加可能） |
| **ページ数** | 全8ページ（認証3 + メイン5） |
| **ユーザーロール** | 管理者、一般ユーザー |

### ページ構成

#### 認証関連ページ（3ページ）

| ページID | ページ名 | 権限 |
|---------|---------|------|
| P-001a | ログインページ | ゲスト |
| P-001b | 招待受諾・パスワード設定ページ | 招待リンク保有者 |
| P-001c | パスワードリセットページ | パスワードリセットリンク保有者 |

#### メイン機能ページ（5ページ）

| ページID | ページ名 | 権限 | 主な機能 |
|---------|---------|------|---------|
| P-002 | PDF処理実行ページ | 全ユーザー | 4つのPDF→Excel編集→PDF生成 |
| P-003 | 処理履歴・ダウンロードページ | 全ユーザー | 過去処理のファイル再ダウンロード |
| P-004 | ユーザー管理ページ | 管理者専用 | ユーザー招待・削除・権限変更 |
| P-005 | 取引先設定ページ | 管理者専用 | テンプレートExcel管理・処理ルール表示 |

### 技術スタック

#### フロントエンド
- React 18
- TypeScript 5.x
- Vite 5.x
- Tailwind CSS 3.x
- shadcn/ui
- Zustand（状態管理）
- Supabase Auth UI

#### バックエンド
- Node.js 20 + Express + TypeScript（API層）
- Python 3.11（処理層）
  - pdfplumber（PDF解析）
  - openpyxl（Excel編集）
  - LibreOffice（PDF生成）

#### データベース・認証
- PostgreSQL 15（Supabase）
- Supabase Auth（招待制）
- Row Level Security（RLS）

#### デプロイ
- フロントエンド: AWS Amplify
- バックエンド: AWS Lambda Docker Image
- データベース: Supabase
- **月額費用**: $0（全て無料枠内）

### データベース設計（4テーブル）

| テーブル名 | 用途 |
|-----------|------|
| **profiles** | ユーザープロファイル（メール、ロール） |
| **companies** | 取引先情報 + テンプレートExcel（最新版のみ保持） |
| **processed_files** | 処理済みファイル（Excel・注文書PDF・検収書PDF） |
| **process_logs** | 処理ログ（成功/エラー、詳細メッセージ） |

### 処理フロー

1. **PDFアップロード**（見積書・請求書・注文請書・納品書の4ファイル）
2. **取引先自動判別**（PDF内容から特定）
3. **事前チェック**（フォーマット検証・データ確認・金額整合性）
4. **前回Excelの取得**
   - 初回: 手動アップロード → DB保存
   - 2回目以降: DB自動取得
5. **Excel自動編集**（処理ルールに従ってデータ転記、数式は保持）
6. **PDF生成**（注文書PDF・検収書PDF）
7. **DB保存 + ダウンロード提供**

---

## ⏱️ 開発スケジュール見積もり

### Phase別作業時間

| Phase | 作業内容 | AI作業時間 | あなたの作業時間 | 合計時間 |
|-------|---------|-----------|----------------|---------|
| **Phase 1** | 要件定義 | 3時間 | 3時間 | ✅ **6時間（実績）** |
| **Phase 2** | Git/GitHub管理 | 0.5時間 | 0.5時間 | 1時間 |
| **Phase 3** | フロントエンド基盤 | 1時間 | 0.5時間 | 1.5時間 |
| **Phase 4** | ページ実装 | 6-8時間 | 2-3時間 | 8-11時間 |
| **Phase 5** | 環境構築 | 0.5時間 | 1時間 | 1.5時間 |
| **Phase 6** | バックエンド計画 | 1時間 | 0.5時間 | 1.5時間 |
| **Phase 7** | バックエンド実装 | 8-10時間 | 2-3時間 | 10-13時間 |
| **Phase 8** | API統合 | 3-4時間 | 1-2時間 | 4-6時間 |
| **Phase 9** | E2Eテスト | 2-3時間 | 1時間 | 3-4時間 |
| **Phase 10** | デプロイメント | 2-3時間 | 2-3時間 | 4-6時間 |
| **合計** | - | **27-36時間** | **14-19時間** | **41-55時間** |

### 完成目標（平日1日4時間の場合）

- **所要日数**: 10〜14日（平日ベース）
- **カレンダー換算**: 約2.5〜3週間
- **現実的な目標**: 3週間で完成

---

## 🔑 重要な決定事項

### P-002（PDF処理実行ページ）の詳細仕様

- 4つのPDF統合アップロード（ドラッグ&ドロップ）
- 自動判別（取引先特定）→ 2列表示（見積書・請求書 / 注文請書・納品書）
- 個別差し替え可能
- 初回のみExcelアップロード、2回目以降は前回Excelを自動取得
- 7つの画面状態:
  1. 初期状態（PDFドロップゾーン）
  2. アップロード中
  3. 判別中（自動判別実行）
  4. 判別完了・事前チェック完了（初回: Excelアップロード待ち）
  5. 判別完了・事前チェック完了（2回目以降: 処理実行可能）
  6. 処理中（プログレスバー）
  7. 処理完了（ダウンロードボタン表示）

### P-004（ユーザー管理ページ）の保護機能

- **自分自身の保護**: 削除・権限変更ボタンをグレーアウト
  - メッセージ: 「💡 自分自身は編集できません」
- **最終管理者の保護**: 管理者が1人のみの場合、削除・降格ボタンをグレーアウト
  - メッセージ: 「💡 管理者が1人のため削除/変更できません」
- **権限変更**: 即座に適用（モーダルなし）
- **削除**: 確認モーダル表示

### P-005（取引先設定ページ）の処理ルール

- **Phase 1（MVP）**: 開発者がコード修正
- **Phase 2（将来）**: 設定ファイル方式
- **Phase 3（将来）**: GUI設定画面
- 初期段階では処理ルールは読み取り専用で表示のみ
- Excelの数式はそのまま保持（システムはデータ転記のみ）

### データベース設計の重要決定

- **テンプレートExcel**: companiesテーブルに直接保存（履歴なし、最新版のみ保持）
- **処理用Excel**: processed_filesテーブルに毎回保存（履歴あり）
- **ファイル保存方式**: BYTEA型でDB内保存（URLリンクでの直接アクセス不可、ログイン後にのみダウンロード可能）

### 技術スタック決定の経緯

- **デプロイ先**: AWS（ユーザー要望）
- **無料構成**: AWS Amplify + Lambda Docker Image + Supabase
- **コールドスタート**: 5〜10秒（月次処理なので影響軽微）
- **LibreOffice**: Lambda Docker Image（最大10GB）で実行可能
- **ローカル開発**: Phase 1-9はローカル完結、Phase 10でのみAWS使用

---

## 📝 微調整・修正履歴

### 表現の修正

1. **月間工数削減**: 「取引先2社で月20分程度」→「取引先2社で月20分程度削減」に修正
2. **PDFの用途**: 請求書のみ「データ抽出元・検証」→ 全PDF「データ抽出元」に統一
3. **ファイル保護の表現**: 「URLで直接アクセス不可、認証済みユーザーのみ」→「URLリンクでの直接アクセス不可、ログイン後にのみダウンロード可能」に変更
4. **ポート番号**: localhost:5173、localhost:3000に「(例)」を追加

### 仕様の訂正

1. **Excel構造**: 2ファイル（注文書・検収書）→ 1ファイル2シート構造に訂正
2. **テンプレートExcel管理**: 独立テーブル（template_excels）→ companiesテーブルに統合

---

## 💡 重要な気づき・質疑応答

### Q1: コールドスタートって何ですか？
**A**: Lambda関数が初めて起動する際の5〜10秒の待ち時間。月次処理は月1回実行なので毎回初回起動となるが、処理全体が数分かかるため誤差範囲内。ユーザー体験への影響はほぼなし。

### Q2: ローカル開発にもAWSは必要ですか？
**A**: Phase 1-9まではローカルで完全に開発・テスト可能。AWS Amplify・Lambdaは最後のデプロイ時（Phase 10）のみ必要。開発中は普通に`npm run dev`で実行。

### Q3: テンプレートExcelと処理用Excelの違いは？
**A**:
- **テンプレートExcel**: P-005で管理、初回処理時に使用、履歴なし（最新版のみ）
- **処理用Excel**: 毎回更新されるもの、履歴あり、2回目以降は前回分を自動取得

### Q4: Phase 1が6時間かかった理由は？
**A**: 要件定義は対話・思考・判断が多く時間がかかるフェーズ。Phase 2以降は決まった要件を実装する作業フェーズなので速く進む。

### Q5: モックアップはいつ作りますか？
**A**: Phase 4（ページ実装）で作成。いきなり実装（推奨）か、モックアップ先行かはPhase 4開始時に判断可能。UIがシンプルなので、いきなり実装を推奨。

### Q6: ケン・トンプソンとは？
**A**: UNIX、C言語の開発者。CLAUDE.mdでコーディング時の思想・姿勢を示すペルソナとして採用。シンプルで明瞭、保守性重視の開発哲学。

### Q7: レコンXとは？
**A**: BlueLampシステム独自の架空のエンジニアキャラクター。要件定義に特化した仮想エンジニアペルソナで、10ステップの要件定義プロセスをガイドする役割。

### Q8: Step#8（SCOPE_PROGRESS進捗表挿入）の役割は？
**A**: プロジェクト全体の進捗を可視化する管理表を作成。Phase 1-10の進捗状況と全8ページの実装状況を追跡するための台帳。

### Q9: Step#9（CLAUDE.md生成）の役割は？
**A**: Phase 2以降の実装時にAI（Claude）が守るべき開発ルールを記載したファイルを生成。型定義同期、コーディング規約、テストポリシー等を定義し、プロジェクト固有のルールを守った実装を可能にする。

### Q10: Step#10で深掘りが必要なケースは？
**A**: 複雑なUI/UX、複雑なビジネスロジック、外部連携が複雑、画面遷移が複雑な場合。今回はシンプルなので深掘り不要と判断。

---

## 🚀 次のアクション

**Phase 2: Git/GitHub管理** へ進む

- GitHubリポジトリを作成
- プロジェクトの開発環境を準備
- 所要時間: 約1時間

---

## 📊 Phase 1 完了メトリクス

| 項目 | 値 |
|------|-----|
| **作業日** | 2025-10-07 |
| **所要時間** | 6時間（実績） |
| **生成ファイル数** | 5ファイル |
| **要件定義書行数** | 612行 |
| **確定ページ数** | 8ページ |
| **確定テーブル数** | 4テーブル |
| **対話ラウンド数** | 約50回 |
| **微調整・修正回数** | 6回 |

---

**Phase 1ステータス**: ✅ 完了
**作成者**: BlueLamp要件定義エンジニア（レコンX）
**次回セッション**: Phase 2（Git/GitHub管理）から開始

🎉 **お疲れさまでした！Phase 1完了です** 🎉
