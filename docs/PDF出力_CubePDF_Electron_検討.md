# PDF出力問題とCubePDF/Electron化の検討まとめ

**作成日**: 2025-12-12
**最終更新**: 2026-01-05
**ステータス**: 検討継続中（Excel直接出力方式を検証中）

---

## 1. 現状の問題

### LibreOffice出力とCubePDF出力の差異

| 項目 | CubePDF（目標） | LibreOffice（現状） | 差異 |
|------|----------------|-------------------|------|
| コンテンツ高さ | 25.53cm | 22.17cm | **14%小さい** |
| コンテンツ幅 | 17.23cm | 17.22cm | ほぼ同じ |
| 文字サイズ | 8.3pt | 6.6pt | **14%小さい** |
| 文字縦横比 | 1.00 | 1.00 | 同じ（正常） |

### 原因

- CubePDFとLibreOfficeで「1ページに収める」機能の解釈が異なる
- CubePDF: 横幅を基準にスケーリング（縦方向はあまり縮小しない）
- LibreOffice: 縦横均等にスケーリング（両方向を同比率で縮小）
- **これはPDF変換エンジンの仕様差であり、コード側での完全な解決は不可能**

### 試行した解決策（全て不可）

| 試行内容 | 結果 |
|----------|------|
| openpyxlでスケール100%に設定 | 効果なし（fitToPageが優先される） |
| XML直接編集でfitToPage削除 | 8ページに分割（コンテンツがA4超過） |
| 印刷範囲（Print_Area）設定 | 8→4ページに改善するが不十分 |
| LibreOffice UNO APIでスケール調整 | 効果なし |
| pypdfでPDF後処理（縦方向のみ拡大） | サイズは近くなるが文字が縦長に変形 |
| pypdfでPDF後処理（縦横同比率拡大） | 右端がA4からはみ出す |
| 行高さ・列幅を拡大 | LibreOfficeがさらに縮小するだけ |

---

## 2. 重要な発見事項（2025-12-26 追加）

### 2.1 CubePDFの制限事項

公式FAQを調査した結果、重要な制限が判明：

| 項目 | 結果 | 出典 |
|------|------|------|
| **GUIを非表示にできるか** | ❌ できない | [公式FAQ](https://clown.cube-soft.jp/entry/cubepdf/faq/basic) |
| **コマンドラインから使えるか** | ❌ 困難 | GUIアプリとして設計 |
| **サイレント自動出力** | ❌ CubePDF単体では不可能 | 公式FAQ |

**「GUIを非表示にできない」の意味**:
- CubePDFは仮想プリンターとして動作
- 印刷すると必ずダイアログが表示され、人間が「変換」ボタンを押す必要がある
- 自動化システムでは毎回ダイアログで止まってしまい、完全自動化が不可能

### 2.2 Excel直接出力（ExportAsFixedFormat）の発見

CubePDFの制限を回避するシンプルな方法を発見：

```powershell
# ダイアログなしで直接PDF出力
$sheet.ExportAsFixedFormat(0, "C:\output\order.pdf")
```

**メリット**:
- 追加インストール不要（Excel既存機能）
- 仮想プリンター不要
- 出力先を引数で直接指定可能
- シート別出力が簡単
- **完全自動化が可能**

### 2.3 Excel直接出力のテスト結果

**テスト日時**: 2026-01-05

**入力ファイル**: `tests/e2e/fixtures/nextbits/テラ【株式会社ネクストビッツ御中】注文検収書_2506.xlsx`（実装テンプレート）

**結果**:

| 出力ファイル | サイズ | 状態 |
|-------------|--------|------|
| `test_order_2506.pdf`（注文書） | 190KB | ✅ 生成成功 |
| `test_inspection_2506.pdf`（検収書） | 190KB | ✅ 生成成功 |

**注意**: 初回テスト（2025-12-26）では誤って別ファイル（2507）を使用していた。正しいテンプレート（2506）で再テスト済み。

---

## 3. 解決策の選択肢（更新版）

### 選択肢A: LibreOffice版で運用（現状）

**メリット:**
- 追加開発不要
- Linux環境（AWS Lambda）で動作
- 月額費用$0

**デメリット:**
- PDF出力がCubePDFより14%小さい
- 印刷すれば読めるが、見た目の差がある

### 選択肢B: Excel直接出力版（推奨）

**メリット:**
- CubePDF不要（Excelの標準機能）
- GUI非表示で完全自動化可能
- 追加インストール不要（Excel既存）
- 実装工数が少ない（0.5日程度）

**デメリット:**
- Windows + Excel環境が必要
- AWS Lambda（Linux）では使えない

### ~~選択肢C: CubePDF版~~ → **断念**

CubePDFはGUI非表示にできないため、自動化システムには不適切。

### 選択肢D: Electron化してデスクトップアプリ配布

**メリット:**
- 各ユーザーのWindows PCで完結
- Excel直接出力が使える（PDF品質問題解決）
- サーバー不要（Supabaseのみ）
- 社内配布で外部アクセス不可

**デメリット:**
- 開発工数がかかる（約3日）
- アップデート時に再配布が必要
- 詳細は「5. Electron化の詳細」を参照

---

## 4. デプロイ先による制約（更新版）

| デプロイ先 | OS | Excel直接出力 | PDF品質 | 費用 |
|-----------|-----|--------------|---------|------|
| AWS Lambda + Amplify | Linux | ❌ | △ 14%縮小 | $0 |
| 社内Windows PC（Webアプリ） | Windows | ✅ | ◎ | $0 |
| Electron配布 | Windows | ✅ | ◎ | $0 |
| レンタルVPS（Windows） | Windows | ✅ | ◎ | 月2000-5000円 |

---

## 5. Electron化の詳細

### 5.1 メリット

| 項目 | 内容 |
|------|------|
| **配布が簡単** | .exeをダブルクリックで起動、環境構築不要 |
| **オフライン対応** | ローカルで動作（※Supabase接続は必要） |
| **デスクトップ統合** | ファイルドラッグ&ドロップ、通知、ショートカット |
| **ブラウザ不要** | 専用アプリとして動作 |
| **Excel直接出力** | Windows APIを使えるのでPDF品質問題が解決 |

### 5.2 デメリット

| 項目 | 内容 |
|------|------|
| **ファイルサイズ大** | 250-300MB（Chromium + Node.js + Python同梱） |
| **メモリ消費** | 200-500MB（Chromiumが重い） |
| **更新が面倒** | 新バージョンを毎回配布・差し替え |
| **開発工数** | 追加で約3日必要 |
| **Windowsのみ** | Excel直接出力を使うとWindowsのみ |

### 5.3 危険性・リスク

| リスク | 影響 | 対策 |
|--------|------|------|
| **セキュリティ脆弱性** | Electron/Chromiumの脆弱性がそのまま影響 | 定期的なElectronアップデート |
| **コード署名なし** | Windows Defenderに警告される | 社内配布なら除外設定で対応可 |
| **機密情報の露出** | ソースコードがasarに含まれる（難読化なし） | 社内限定配布なら許容範囲 |
| **依存関係の複雑化** | Electron + Python + Node.jsの組み合わせ | バージョン固定、テスト徹底 |
| **メンテナンス負荷** | Web版とElectron版の両方を保守 | 共通コードを最大化 |

### 5.4 サイズ見積もり

**開発環境（現状）**:

| コンポーネント | サイズ |
|---------------|--------|
| フロントエンド node_modules | 420MB |
| バックエンド node_modules | 109MB |
| プロジェクト全体 | 938MB |

**配布用exe（最適化後）**:

| コンポーネント | サイズ |
|---------------|--------|
| Electron本体（Chromium） | 150MB |
| フロントエンド（ビルド後） | 5-10MB |
| バックエンド（本番用） | 20-30MB |
| Python（PyInstaller後） | 50-100MB |
| **合計** | **250-300MB** |

### 5.5 最適化で行うこと

| 処理 | 効果 |
|------|------|
| **フロントエンドビルド** | Tree-shaking、Minify、バンドル → 420MB → 5-10MB |
| **バックエンド本番ビルド** | devDependencies削除 → 109MB → 20-30MB |
| **Python exe化** | PyInstallerで必要ライブラリのみ同梱 → 50-100MB |
| **不要ファイル除外** | テスト、ドキュメント、.git等を除外 |

**electron-builder**が自動で最適化してくれるため、手作業は不要。

### 5.6 参考：他のElectronアプリのサイズ

| アプリ | サイズ |
|--------|--------|
| Slack | 約300MB |
| VSCode | 約300MB |
| Discord | 約150MB |
| **本システム（予想）** | **250-300MB** |

---

## 6. 推奨方針（更新版）

### 方針変更（2026-01-05）

**AWSデプロイは行わず、Electron配布で完了とする**

理由：
- 社内の他のユーザーも使う必要がある
- PDF品質問題を解決したい（Excel直接出力を使用）
- Electron配布ならWindows + Excelで完結

### 最終ゴール

```
Excel直接出力版 + Electron化 → .exe配布
```

### 前提条件：SMTP設定が必要

Electron配布しても認証はSupabase経由のため、ユーザー招待にはメール送信が必要。
詳細は `docs/SMTP設定_進捗.md` を参照。

---

## 7. 費用まとめ

| 項目 | 費用 |
|------|------|
| LibreOffice | 無料 |
| Excel直接出力 | 無料（Excel既存機能） |
| Electron | 無料 |
| Supabase | 無料枠内 |
| AWS Lambda + Amplify | 無料枠内 |

**どの選択肢でも月額$0で運用可能**

---

## 8. 次のステップ（更新版）

### 完了済み
| # | タスク | 状態 |
|---|--------|------|
| 1 | LibreOffice版で Phase 8（API統合）完了 | ✅ |
| 2 | CubePDFの制限事項調査完了（GUI非表示不可） | ✅ |
| 3 | Excel直接出力のテスト完了（2506テンプレートで確認） | ✅ |
| 4 | E2Eテスト 138/140項目完了（99%） | ✅ |

### 進行中：SMTP設定（ブロッカー）

E2Eテスト残り2項目（E2E-USER-003, E2E-USER-014）はメール送信が必要。
Supabase無料SMTPのレート制限（2通/時間）が解除不可のため、カスタムSMTP設定が必須。

| # | タスク | 担当 | 状態 |
|---|--------|------|------|
| 5-1 | ドメイン管理者にサブドメイン名を確認 | 岩舟 | ⏳ |
| 5-2 | Resendでサブドメインを追加 | 岩舟 | 待機 |
| 5-3 | DNSレコード（TXT, CNAME）を管理者に依頼 | 岩舟 | 待機 |
| 5-4 | DNS設定完了後、Resendで認証確認 | 岩舟 | 待機 |
| 5-5 | SupabaseのSMTP設定を更新（ポート465、送信元変更） | 岩舟 | 待機 |
| 5-6 | テスト送信で動作確認 | 岩舟 | 待機 |

詳細は `docs/SMTP設定_進捗.md` を参照。

### 次のフェーズ：Excel直接出力版の実装

| # | タスク | 工数目安 | 状態 |
|---|--------|---------|------|
| 6-1 | 環境変数 `PDF_ENGINE` の追加（libreoffice/excel切替） | 0.5h | 待機 |
| 6-2 | WSL→Windowsパス変換ロジック追加 | 0.5h | 待機 |
| 6-3 | PowerShellスクリプト生成・実行ロジック | 1h | 待機 |
| 6-4 | Excel直接出力版の統合テスト | 1h | 待機 |

### 最終フェーズ：Electron化

| # | タスク | 工数目安 | 状態 |
|---|--------|---------|------|
| 7-1 | electron-builder設定 | 2h | 待機 |
| 7-2 | メインプロセス/レンダラー分離 | 2h | 待機 |
| 7-3 | Python実行環境の組み込み（PyInstaller） | 4h | 待機 |
| 7-4 | ビルド・パッケージング | 2h | 待機 |
| 7-5 | 動作確認・配布テスト | 2h | 待機 |

### E2Eテスト完了（SMTP設定後）

| # | タスク | 状態 |
|---|--------|------|
| 8-1 | E2E-USER-003: 招待メール送信テスト | 待機 |
| 8-2 | E2E-USER-014: 管理者招待フローテスト | 待機 |

### ~~削除：AWSデプロイ~~

方針変更により、AWS Lambda + Amplifyへのデプロイは行わない。
Electron配布で完了とする。

---

## 付録A: 技術的な発見事項

### LibreOfficeのfitToPage動作

- `fitToPage="1"`が設定されている場合、`scale`属性は無視される
- LibreOfficeは独自にスケールを計算して1ページに収める
- fitToPageを削除すると、コンテンツがA4サイズを超過してはみ出す

### テンプレートExcelの構造

- dimension（XML）: `B2:AS47`（45列）
- 実データの最大列: AC列（29列目）
- コンテンツ幅: 22.83cm > A4幅21cm（100%スケールでははみ出す）
- 印刷範囲（Print_Area）: 未設定

### CubePDFの動作推測

- 横幅を基準にスケーリングし、縦方向は可能な限り維持
- または、Windows GDIの印刷処理が異なる解釈をしている

---

## 付録B: node_modulesとは

**npm（Node.jsのパッケージマネージャー）でインストールしたライブラリが入るフォルダ**

### このプロジェクトで使っているもの（一部）

**フロントエンド（420MB）**:
| パッケージ | 用途 |
|-----------|------|
| react | UI構築 |
| @mui/material | デザインコンポーネント |
| vite | 開発サーバー・ビルド |
| typescript | 型チェック |

**バックエンド（109MB）**:
| パッケージ | 用途 |
|-----------|------|
| express | APIサーバー |
| @supabase/supabase-js | DB接続 |
| ts-node | TypeScript実行 |

### なぜ大きいのか

```
react をインストール
  → react が依存する別のライブラリもインストール
    → そのライブラリが依存する別のライブラリも...
      → 数百〜数千のパッケージに膨らむ
```

**依存関係の連鎖**で大きくなる。

### 配布時に含めない理由

- 開発用ツール（テスト、型チェック等）が半分以上
- ビルド後は不要（コードに組み込まれる）
- だから938MB → 250-300MBに減る

---

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-12 | 初版作成 |
| 2026-01-05 | CubePDF制限事項、Excel直接出力、Electron化詳細、サイズ見積もりを追加 |
| 2026-01-05 | 方針変更（AWSデプロイ中止→Electron配布）、SMTP設定タスク追加、タスク整理 |
