# 要件定義進捗記録

**プロジェクト名**: 月次処理自動化システム
**開始日**: 2025-10-06
**最終更新**: 2025-10-07

---

## 進捗状況

```
✅ Step#1: 成果定義の確定 - 完了
✅ Step#2: 実現可能性調査（技術的検証） - 完了
✅ Step#3: 認証・権限設計 - 完了
✅ Step#4: 必要なページリスト作成 - 完了（全8ページ確定）
✅ Step#5: 技術スタック最終決定 - 完了
✅ Step#6: 外部API最終決定 - 完了
✅ Step#7: 要件定義書の書き出し - 完了
✅ Step#8: SCOPE_PROGRESS進捗表挿入 - 完了
✅ Step#9: CLAUDE.md生成 - 完了
✅ Step#10: ページの深掘り - 完了（深掘り不要と判断）
```

---

## Step#1: 成果定義の確定 ✅

### a) 成果Yの詳細な定義

毎月25日～翌月5日に受領する4種類のPDF（見積書・請求書・注文請書・納品書）を事前チェックし、取引先を自動判別、先月分のExcel（注文書・検収書）を各社の処理ルールに従って自動編集。処理結果（ExcelファイルとPDF 2種）を1分以内で出力し、DBに永久保存。ログイン機能により過去の処理結果をいつでもダウンロード可能。管理者と一般ユーザーの権限分離に対応した業務自動化システム

### b) 成功を測る定量的指標

- **処理時間**: 手作業10分→自動化1分以内（90%削減）
- **エラー事前検知率**: 処理開始前に100%の問題を検知・通知
- **処理成功率**: 事前チェック通過後は100%成功
- **月間工数削減**: 取引先2社で月20分程度の削減

### c) 成功を測る定性的指標

- **脱属人化**: マニュアルを見ずに誰でも実行可能
- **ストレスフリー**: 定型業務から解放され創造的業務に集中できる
- **安心感**: 事前チェックで問題を検知し、エラーなく処理完了
- **トレーサビリティ**: 過去の処理結果をいつでも参照・再ダウンロード可能
- **将来対応**: ユーザー増加・取引先追加に柔軟に対応可能

---

## Step#2: 実現可能性調査（技術的検証） ✅

### 調査結果サマリー

#### ✅ 実現可能な要素

1. **PDF解析・データ抽出**
   - **推奨技術**: pdfplumber（Python）
   - 日本語PDF、テーブル構造の抽出が可能
   - 取引先ごとの異なるフォーマット対応可能
   - 並列処理により4ファイル10秒以内で処理可能

2. **Excel自動編集**
   - **推奨技術**: openpyxl（Python） + LibreOffice
   - 既存テンプレートのフォーマット完全保持
   - セル編集、数式保持、スタイル維持すべて対応
   - Excel→PDF変換可能（5-15秒）

3. **ファイル保存・ダウンロード**
   - **推奨技術**: PostgreSQL BYTEA型で直接保存
   - Supabase PostgreSQLの無料枠500MB（年間36MBなので十分）
   - 認証済みユーザーのみアクセス可能

4. **認証・権限管理**
   - **推奨技術**: Supabase Auth
   - 2つのロール（管理者・一般ユーザー）実装可能
   - Row Level Securityでデータベースレベルの権限制御
   - 無料枠10,000 MAUまで対応

#### 必要な外部サービス

| サービス名 | 用途 | 無料枠 | 備考 |
|-----------|------|--------|------|
| **Supabase** | 認証 + DB + ファイル保存 | 10,000 MAU、500MB DB | PostgreSQL完全互換 |
| **Vercel** | フロントエンドホスティング | 無料 | React自動デプロイ |
| **Google Cloud Run** | バックエンドホスティング | 月200万リクエスト無料 | Node.js + Python |

#### 概算コスト

- **初期費用**: $0
- **月額費用**: $0（無料枠内で十分）
- **年間費用**: $0

---

## Step#3: 認証・権限設計 ✅

### ユーザーロールと権限

| ロール | できること |
|--------|----------|
| **管理者** | ・ユーザー管理（招待・削除・権限変更）<br>・処理実行<br>・全ユーザーのデータ閲覧・ダウンロード<br>・処理ログ閲覧<br>・エラーログ閲覧<br>・取引先設定管理 |
| **一般ユーザー** | ・処理実行<br>・全ユーザーのデータ閲覧・ダウンロード<br>・処理ログ閲覧<br>・エラーログ閲覧 |

**注**: 管理者と一般ユーザーの実質的な違いは「ユーザー管理機能」と「取引先設定管理機能」のみ

### 認証方式

- **招待制**: 管理者が招待メールを送信、ユーザーが自分でパスワードを設定して登録
- メール＋パスワード認証
- パスワードの自動ハッシュ化（bcrypt）
- JWTトークンベースのセッション管理
- Row Level Security（データベースレベルの権限制御）

### 認証フロー

#### 初回登録

```
1. 管理者が「ユーザー管理」画面でメールアドレスを入力して招待
   ↓
2. ユーザーに招待メールが届く
   ↓
3. メール内の「招待リンク」をクリック
   ↓
4. 「パスワード設定ページ」に移動
   ↓
5. パスワードを設定して登録完了
   ↓
6. 自動的にログインして、処理実行ページへ
```

#### 2回目以降のログイン

```
1. ログインページにアクセス
   ↓
2. メールアドレス + パスワードを入力
   ↓
3. ログイン
```

---

## Step#4: 必要なページリスト作成 ✅

### システム名

**月次処理自動化システム**

### 確定済みページ（全8ページ）

#### 認証関連ページ（3ページ）

##### P-001a: ログインページ
- **目的**: システムへのログイン
- **権限**: ゲスト（未ログイン）
- **機能**:
  - メールアドレス入力
  - パスワード入力
  - ログイン状態を保持するチェックボックス
  - ログインボタン
  - パスワードリセットリンク
  - システム名表示

##### P-001b: 招待受諾・パスワード設定ページ
- **目的**: 初回登録時のパスワード設定
- **権限**: 招待リンクを持つユーザー
- **機能**:
  - メールアドレス表示（変更不可）
  - パスワード入力（8文字以上）
  - パスワード確認入力
  - アカウント作成ボタン

##### P-001c: パスワードリセットページ
- **目的**: パスワードを忘れた場合の再設定
- **権限**: パスワードリセットリンクを持つユーザー
- **機能**:
  - 新しいパスワード入力（8文字以上）
  - パスワード確認入力
  - パスワード変更ボタン

---

#### メイン機能ページ（5ページ）

##### P-002: PDF処理実行ページ ✅ 詳細確定

- **目的**: 4つのPDFをアップロードし、自動処理を実行
- **権限**: 全ユーザー（管理者・一般ユーザー）

**詳細仕様:**

```yaml
PDFアップロード:
  - 4つ必須: 見積書、請求書、注文請書、納品書
  - 統合ドロップゾーンで一括アップロード可能
  - 自動判別して2列表示（見積書・請求書 / 注文請書・納品書）
  - 個別差し替え可能

取引先判別:
  - PDFから完全自動判別
  - 判別結果を表示

事前チェック:
  - アップロード直後に即座にチェック
  - フォーマット検証、データ存在確認

編集対象Excel:
  初回処理:
    - 1つのExcelファイルをアップロード（注文書・検収書シート含む）
    - 統合ドロップゾーンでアップロード
    - DBに保存

  2回目以降:
    - DBから前回のExcelを自動取得
    - 手動アップロード不要

処理実行:
  - プログレスバー表示
  - 処理時間表示

処理完了:
  - 同じページに完了メッセージ
  - 3つのダウンロードボタン（Excel・注文書PDF・検収書PDF）
  - 「処理履歴で確認する」ボタン
  - 「続けて処理する」ボタン
```

**画面遷移:**
```
初期状態（PDFドロップゾーン）
  ↓ 4つのPDFをドロップ
判別中（自動判別実行）
  ↓
判別完了・事前チェック完了
  ↓ [初回のみ] Excelアップロード
処理実行可能
  ↓ [処理を実行]ボタン
処理中（プログレスバー）
  ↓
処理完了（ダウンロードボタン表示）
```

---

##### P-003: 処理履歴・ダウンロードページ
- **目的**: 過去の処理結果を閲覧・再ダウンロード
- **権限**: 全ユーザー（全員が全データ閲覧可能）
- **機能**:
  - 処理履歴一覧（取引先名・処理日・処理者・状態）
  - フィルター機能（取引先・期間・処理者）
  - ファイルダウンロードボタン（Excel・注文書PDF・検収書PDF）
  - 処理時間表示
  - **最小限のログ機能**:
    - 成功時: 処理時間のみ表示
    - 失敗時: 簡単なエラーメッセージ + 「詳細を見る」ボタン
    - 「詳細を見る」をクリック: モーダル（ポップアップ）でエラー詳細表示
- **成果への貢献**: いつでも過去のファイルを参照・再ダウンロード可能

---

##### P-004: ユーザー管理ページ（管理者専用） ✅ 詳細確定

- **目的**: ユーザーの招待・削除・権限変更
- **権限**: 管理者専用

**詳細仕様:**

```yaml
機能:
  - ユーザー一覧表示（メールアドレス・ロール・登録日）
  - 新規ユーザー招待（メール・権限選択）→ モーダル表示
  - ユーザー削除 → 確認モーダル表示
  - 権限変更 → 即座に適用（モーダルなし）

保護機能:
  自分自身の保護:
    - 削除ボタン: グレーアウト
    - 権限変更ボタン: グレーアウト
    - メッセージ: 💡 自分自身は編集できません

  最終管理者の保護:
    - 管理者が1人のみの場合:
      - 削除ボタン: グレーアウト
      - 降格ボタン: グレーアウト
      - メッセージ: 💡 管理者が1人のため削除/変更できません
    - 管理者が2人以上: 通常通り操作可能

操作フロー:
  招待: モーダル表示 → メール・権限入力 → 招待メール送信
  削除: 確認モーダル表示 → 削除確認 → 実行
  権限変更: 即座に適用 → 完了通知表示
```

---

##### P-005: 取引先設定ページ（管理者専用） ✅ 詳細確定

- **目的**: 取引先ごとの基本情報とテンプレートExcel管理
- **権限**: 管理者専用

**詳細仕様:**

```yaml
取引先:
  - 現在: ネクストビッツ様、オフビートワークス様
  - 将来: 追加可能性あり

機能:
  取引先一覧:
    - 取引先名、状態（有効/無効）、最終処理日
    - 詳細表示、処理ルール確認、有効/無効切り替え
    - 新規取引先追加ボタン（将来用）

  取引先詳細:
    - 基本情報編集（取引先名、宛名）
    - テンプレートExcelの確認・ダウンロード
    - テンプレートExcelの更新（アップロード）
    - 処理履歴の確認

  処理ルール:
    - システム設定済みルールの表示（読み取り専用）
    - マニュアルの可視化
    - 変更は開発者対応（将来的にGUI編集予定）

Excel処理:
  - 数式はそのまま保持
  - システムはデータ転記のみ
  - 実際の計算はExcelが実行

処理ルール例（ネクストビッツ様）:
  自動計算項目（Excelの数式）:
    - 注文番号: yyyymmdd-01 形式
    - 注文書明細タイトル: yyyy年mm月作業費
    - 金額: 数量 × 単価
    - 摘要: 見積番号：***-**-*** 形式

  PDF→Excel転記:
    - 発行日: 前回+1ヶ月の1日
    - 発注金額: 請求書の合計金額
    - 件名: 見積書の件名（パターン変換）
    - 数量: 見積書の数量（1式→1に変換）
    - 単価: 見積書の単価
    - 小計・消費税・合計: 請求書と一致チェック

  固定値チェック:
    - 宛名: 株式会社ネクストビッツ 御中
    - 明細の締め: 以下、余白

マニュアル変更時の対応:
  - フェーズ1（MVP）: 開発者がコード修正
  - フェーズ2（将来）: 設定ファイル方式
  - フェーズ3（将来）: GUI設定画面
```

---

## システム構成（確定）

```
[ユーザー]
    ↓
[React Frontend (Vercel)]
    ↓ REST API
[Node.js API (Google Cloud Run)]
    ↓ HTTP
[Python PDF処理 (Google Cloud Run)]
    ↓
[Supabase PostgreSQL]
 ├─ 認証（Supabase Auth）
 ├─ ユーザー・権限管理
 ├─ ファイル保存（BYTEA型）
 └─ 処理ログ・エラーログ
```

---

## データベース設計（概要）

```sql
-- ユーザープロファイル
CREATE TABLE profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  email TEXT,
  role TEXT CHECK (role IN ('admin', 'user')) DEFAULT 'user',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 取引先
CREATE TABLE companies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  display_name TEXT NOT NULL, -- 宛名（Excel表記）
  is_active BOOLEAN DEFAULT TRUE,
  last_processed_at TIMESTAMPTZ,

  -- テンプレートExcel（最新版のみ保持）
  template_excel BYTEA,
  template_filename TEXT,
  template_updated_at TIMESTAMPTZ,
  template_updated_by UUID REFERENCES profiles(id),

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 処理済みファイル
CREATE TABLE processed_files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id),
  company_id UUID REFERENCES companies(id),
  process_date DATE NOT NULL,

  -- ファイルをバイナリで保存
  excel_file BYTEA NOT NULL,
  excel_filename TEXT NOT NULL,
  order_pdf BYTEA NOT NULL,
  order_pdf_filename TEXT NOT NULL,
  inspection_pdf BYTEA NOT NULL,
  inspection_pdf_filename TEXT NOT NULL,

  -- 処理情報
  processing_time INTEGER, -- 秒
  status TEXT CHECK (status IN ('success', 'error')),
  error_message TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 処理ログ
CREATE TABLE process_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id),
  company_id UUID REFERENCES companies(id),
  status TEXT CHECK (status IN ('success', 'error')),
  error_message TEXT,
  error_detail TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 決定事項まとめ

### ✅ 確定済み

**Step#1-3:**
- システム名: 月次処理自動化システム
- 認証方式: 招待制（Supabase Auth）
- 権限設計: 管理者 vs 一般ユーザー（全員が全データ閲覧可能）
- ファイル保存: PostgreSQL BYTEA型で直接保存

**Step#4（全8ページ確定）:**
- P-001a/b/c: 認証関連ページ
- P-002: PDF処理実行ページ（詳細確定）
  - 4つのPDF必須、統合ドロップゾーン
  - 完全自動判別
  - 初回のみExcel手動アップロード、2回目以降は自動取得
  - ハイブリッド方式（即DL + 履歴確認ボタン）
- P-003: 処理履歴・ダウンロードページ
  - 最小限ログ機能
  - エラー詳細はモーダル表示
- P-004: ユーザー管理ページ（詳細確定）
  - 自分自身の保護: ブロック
  - 最終管理者の保護: ブロック
  - 権限変更は即座に適用、削除は確認モーダル
- P-005: 取引先設定ページ（詳細確定）
  - 基本情報とテンプレートExcel管理
  - 処理ルールは読み取り専用（開発者対応）
  - Excelの数式は保持

---

## Step#5: 技術スタック最終決定 ✅

### 最終決定事項

#### フロントエンド
- **React 18 + TypeScript**
- **Vite** - 高速ビルドツール
- **Tailwind CSS + shadcn/ui** - モダンUI
- **Zustand** - 軽量状態管理
- **Supabase Auth UI** - 認証UI

#### バックエンド
- **AWS Lambda Docker Image** - サーバーレス実行環境
  - Node.js 20 + Express + TypeScript（API層）
  - Python 3.11（処理層）
    - pdfplumber（PDF解析）
    - openpyxl（Excel編集）
    - LibreOffice（PDF変換）
- **Docker Image** - LibreOfficeサポート（最大10GB）

#### データベース
- **Supabase PostgreSQL 15**
  - 認証（Supabase Auth）
  - ファイル保存（BYTEA型）
  - Row Level Security

#### インフラ・デプロイ
- **フロントエンド**: AWS Amplify
  - React自動ビルド・デプロイ
  - 無料枠あり
- **バックエンド**: AWS Lambda Docker Image
  - 100万リクエスト/月 無料
  - Docker Image対応（LibreOffice実行可能）
- **データベース**: Supabase PostgreSQL
  - 10,000 MAU無料
  - 500MB DB無料

### 月額費用

```
AWS Amplify: $0（無料枠内）
AWS Lambda: $0（100万リクエスト/月無料）
Supabase: $0（無料枠内）

合計: $0/月
```

### 初回起動について

- Lambda関数の初回起動（コールドスタート）: 5〜10秒
- 月次処理（月1回実行）のため、毎回初回起動となる
- 処理全体が数分かかるため、初回起動の遅延は誤差範囲内
- ユーザー体験への影響: ほぼなし

### 将来の移行可能性

| 変更内容 | 難易度 | 所要時間 |
|---------|--------|---------|
| Lambda → ECS Fargate | 低 | 2〜3時間 |
| Lambda → EC2 | 低 | 3〜4時間 |
| Amplify → S3 + CloudFront | 低 | 1〜2時間 |
| Supabase → RDS | 中 | 5〜6時間 |

**インフラ層の変更は比較的容易。まずは無料構成で開始し、必要に応じて移行可能。**

---

## Step#6: 外部API最終決定 ✅

### 使用する外部サービス（3つ）

#### 1. Supabase 🔐
- **用途**: データベース + 認証
- **機能**:
  - PostgreSQL 15データベース
  - Supabase Auth（招待制ユーザー管理）
  - Row Level Security（権限制御）
  - ファイルストレージ（BYTEA型でDB保存）
- **無料枠**: 10,000 MAU、500MB DB
- **月額費用**: $0
- **必要タイミング**: 開発開始時から（ローカル開発でも使用）

#### 2. AWS Amplify ☁️
- **用途**: フロントエンドホスティング
- **機能**:
  - Git連携自動デプロイ
  - HTTPS対応
  - CDN配信
- **無料枠**: 月1,000ビルド分、5GB転送
- **月額費用**: $0
- **必要タイミング**: Phase 10（デプロイメント）のみ

#### 3. AWS Lambda ⚡
- **用途**: バックエンドAPI + PDF/Excel処理
- **機能**:
  - サーバーレス実行環境
  - Docker Image対応（LibreOffice実行）
  - 自動スケーリング
- **無料枠**: 100万リクエスト/月
- **月額費用**: $0
- **必要タイミング**: Phase 10（デプロイメント）のみ

### 外部API不要な項目

以下は外部APIを**使用しません**（自前実装）:

- ❌ PDF解析API → pdfplumberで自前実装
- ❌ Excel編集API → openpyxlで自前実装
- ❌ PDF生成API → LibreOfficeで自前実装
- ❌ ファイルストレージサービス → PostgreSQL BYTEA型で保存
- ❌ メール送信サービス → Supabase Auth内蔵機能を使用

### ローカル開発について

```yaml
ローカル開発環境:
  フロントエンド:
    - npm run dev (Vite開発サーバー)
    - localhost:5173 (例)
    - AWS Amplify不要

  バックエンド:
    - npm run dev (Node.js Express)
    - localhost:3000 (例)
    - AWS Lambda不要
    - Dockerも不要（通常のNode.js + Python）

  データベース:
    - Supabase無料プロジェクト（リモート接続）
```

**Phase 1-9まではローカルで完全に開発・テスト可能。AWSは最後のデプロイ時のみ使用。**

---

## 次回の作業

### Step#7: 要件定義書の書き出し

`docs/requirements.md` を生成

### Step#8: SCOPE_PROGRESS進捗表挿入

ページ管理表を `SCOPE_PROGRESS.md` に追加

### Step#9: CLAUDE.md生成

開発ルール設定ファイルを生成

### Step#10: ページの深掘り

必要に応じて詳細な議論

---

---

## Phase 1 完了サマリー

### 成果物

1. ✅ **requirements.md** - 完全な要件定義書（MD版）
2. ✅ **requirements.html** - 完全な要件定義書（HTML版）
3. ✅ **requirements_progress.md** - 要件定義進捗記録
4. ✅ **SCOPE_PROGRESS.md** - 開発進捗管理表（ページ管理表含む）
5. ✅ **CLAUDE.md** - 開発ルール設定ファイル

### 確定事項

- **システム名**: 月次処理自動化システム
- **ページ数**: 全8ページ（認証3 + メイン5）
- **技術スタック**: React 18 + Node.js 20 + Python 3.11 + Supabase + AWS
- **月額費用**: $0（完全無料構成）
- **データベース**: PostgreSQL 15（4テーブル）

### 次のアクション

**Phase 2: Git/GitHub管理** へ進む

---

**記録日時**: 2025-10-07
**Phase 1ステータス**: ✅ 完了
