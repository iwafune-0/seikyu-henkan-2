# 処理ルール詳細

## 概要

本ドキュメントは、月次処理自動化システムにおける各取引先のExcel編集・PDF生成ルールを詳細に記載したものです。
実際のExcelファイル構造を分析し、セル位置・数式・編集対象を明確化しています。

---

# ネクストビッツ

## 入力ファイル

- `テラ【株式会社ネクストビッツ御中】注文検収書_YYMM.xlsx`（テンプレート：前月分）
- `TRR-YY-MMM_お見積書.pdf`（見積書）
- `TRR-YY-MMM_請求書.pdf`（請求書）
- `TRR-YY-MMM_注文請書.pdf`（注文請書）
- `TRR-YY-MMM_納品書.pdf`（納品書）

## 出力ファイル

- `テラ【株式会社ネクストビッツ御中】注文検収書_YYMM.xlsx`
- `注文書_YYMM.pdf`
- `検収書_YYMM.pdf`
- `ネクストビッツ_YYMM.zip`（上記3ファイルを含む）

---

## 手順

### 1. テンプレートExcelをコピーしてリネーム

ファイル名のYYMM部分は「処理対象月の年下2桁+月2桁」（例：2025年7月→2507）

### 2. 注文書シートを編集

- AC2（発行日）: 見積書PDFのファイル名から処理対象月を抽出し、当月1日を入力
  - ファイル名パターン: `TRR-YY-MMM_お見積書.pdf`（例: `TRR-25-007` → 2025年7月1日）
- R18（数量）: 見積書PDFから数量を抽出して入力（「1式」の場合は「1」と入力）
- T18（単価）: 見積書PDFから単価を抽出して入力

### 3. 検収書シートを編集

- R20（数量）: 注文書シートR18と同じ内容を入力
- T20（単価）: 注文書シートT18と同じ内容を入力

### 4. 注文書シートをチェック

- AC3（注文番号）: `yyyymmdd-01` 形式になっているか（数式 `=TEXT(AC2,"yyyymmdd")&"-01"` で自動計算）
- B8（宛名）: 「株式会社ネクストビッツ　御中」になっているか
- T9〜T12（テラ情報）: 宛名の右側に入っているか
- G12（発注金額）: 請求書PDFの合計金額と一致するか（数式 `=W41` で自動計算）
- C17（明細タイトル）: 「yyyy年mm月分作業費」形式になっているか（数式 `=TEXT(注文書!$AC$2,"yyyy年ｍｍ月分作業費")` で自動計算）
- AA17（摘要）: 見積書右上の「No.TRR-YY-0MM」が「見積番号：TRR-YY-0MM」形式で表示されているか（数式 `="見積番号：TRR-"&TEXT(注文書!$AC$2,"yy-")&"0"&TEXT(注文書!$AC$2,"mm")` で自動計算）
- C18（件名）: 見積書の件名が「yyyy年mm月作業：Telemasシステム改修作業等」の場合、「　Telemas作業(システム改修等)」になっているか（先頭に全角スペース）
- W18（金額）: 数式 `=T18*R18` で自動計算されているか
- C19（明細締め）: 「以下、余白」になっているか
- W39（小計）: 請求書PDFの消費税10%対象と一致するか（数式 `=SUM(W16:Z38)` で自動計算）
- W40（消費税）: 請求書PDFの消費税(10%)と一致するか（数式 `=ROUNDDOWN(W39*0.1,0)` で自動計算）
- W41（合計金額）: 請求書PDFの合計金額と一致するか（数式 `=W39+W40` で自動計算）

### 5. 検収書シートをチェック

- AC4（検収番号）: `yyyymmdd-01` 形式になっているか（数式 `=注文書!AC3` で自動計算）
- AC5（検収日）: 当月末日になっているか（数式 `=EOMONTH(注文書!$AC$2,0)` で自動計算、土日祝日でもそのまま）
- B7（宛名）: 「株式会社ネクストビッツ　御中」になっているか
- T7〜T10（テラ情報）: 宛名の右側に入っているか
- AC11付近（検収印）: 玉置さんの印（画像）が貼付されているか
- G14（合計金額）: 請求書PDFの合計金額と一致するか（数式 `=W43` で自動計算）
- C19（明細タイトル）: 「yyyy年mm月分作業費」形式になっているか（数式 `=注文書!C17` で自動計算）
- AA19（摘要）: 見積書右上の「No.TRR-YY-0MM」が「見積番号：TRR-YY-0MM」形式で表示されているか（数式 `=注文書!AA17` で自動計算）
- C20（件名）: 見積書の件名が「yyyy年mm月作業：Telemasシステム改修作業等」の場合、「　Telemas作業(システム改修等)」になっているか（先頭に全角スペース）
- W20（金額）: 数式 `=T20*R20` で自動計算されているか
- C21（明細締め）: 「以下、余白」になっているか
- W41（小計）: 請求書PDFの消費税10%対象と一致するか（数式 `=SUM(W18:Z40)` で自動計算）
- W42（消費税）: 請求書PDFの消費税(10%)と一致するか（数式 `=ROUNDDOWN(W41*0.1,0)` で自動計算）
- W43（合計金額）: 請求書PDFの合計金額と一致するか（数式 `=W41+W42` で自動計算）

### 6. PDF生成

- 注文書シートを `注文書_YYMM.pdf` として出力
- 検収書シートを `検収書_YYMM.pdf` として出力

### 7. ZIP生成

- `ネクストビッツ_YYMM.zip` を生成（Excel + 注文書PDF + 検収書PDF）

---

# オフ・ビート・ワークス

## 入力ファイル

- `テラ【株式会社オフ・ビート・ワークス御中】注文検収書_YYMM.xlsx`（テンプレート：前月分）
- `NNNNNNN-見積-offbeat-to-terra-YYYYMM.pdf`（見積書）
- `NNNNNNN-請求_offbeat-to-terra-YYYYMM.pdf`（請求書）
- `請書_offbeat-to-terra-YYYYMM.pdf`（注文請書）
- `NNNNNNN-納品-offbeat-to-terra-YYYYMM.pdf`（納品書）

## 出力ファイル

- `テラ【株式会社オフ・ビート・ワークス御中】注文検収書_YYMM.xlsx`
- `注文書_YYMM.pdf`
- `検収書_YYMM.pdf`
- `オフ・ビート・ワークス_YYMM.zip`（上記3ファイルを含む）

---

## 手順

### 1. テンプレートExcelをコピーしてリネーム

ファイル名のYYMM部分は「処理対象月の年下2桁+月2桁」（例：2025年7月→2507）

### 2. 注文書シートを編集

- AC2（発行日）: 注文請書PDFから日付を抽出して入力
- AA17（摘要）: 見積書PDFから見積書番号を抽出して「見積番号：NNNNNNN」形式で入力（7桁）
- C18〜（明細件名）: 請求書PDFから品目を抽出、先頭に「・」を付けて入力（複数ある場合は1行ずつ）
- R18〜（数量）: 請求書PDFから数量を抽出して入力
- T18〜（単価）: 請求書PDFから単価を抽出して入力
- 明細最終行の次の行C列: 「以下、余白」を入力

### 3. 検収書シートを編集

- C20〜（明細件名）: 注文書シートC18〜と同じ内容を入力
- R20〜（数量）: 注文書シートR18〜と同じ内容を入力
- T20〜（単価）: 注文書シートT18〜と同じ内容を入力
- 明細最終行の次の行C列: 「以下、余白」を入力

### 4. 注文書シートをチェック

- AC3（注文番号）: `yyyymmdd-02` 形式になっているか（数式 `=TEXT(AC2,"yyyymmdd")&"-02"` で自動計算）
- B8（宛名）: 「株式会社オフ・ビート・ワークス　御中」になっているか
- T9〜T12（テラ情報）: 宛名の右側に入っているか
- G12（発注金額）: 請求書PDFの合計と一致するか（数式 `=W41` で自動計算）
- C17（明細タイトル）: 「yyyy年mm月作業費」形式になっているか（数式 `=TEXT(注文書!$AC$2,"yyyy年ｍｍ月作業費")` で自動計算）
- W18〜（金額）: 数式 `=T{n}*R{n}` で自動計算されているか
- W39（小計）: 請求書PDFの小計と一致するか（数式 `=SUM(W16:Z38)` で自動計算）
- W40（消費税）: 請求書PDFの消費税額合計と一致するか（数式 `=ROUNDDOWN(W39*0.1,0)` で自動計算）
- W41（合計金額）: 請求書PDFの合計と一致するか（数式 `=W39+W40` で自動計算）

### 5. 検収書シートをチェック

- AC4（検収番号）: `yyyymmdd-02` 形式になっているか（数式 `=注文書!AC3` で自動計算）
- AC5（検収日）: 当月末日になっているか（数式 `=EOMONTH(注文書!$AC$2,0)` で自動計算、土日祝日でもそのまま）
- B7（宛名）: 「株式会社オフ・ビート・ワークス　御中」になっているか
- T7〜T10（テラ情報）: 宛名の右側に入っているか
- AC11付近（検収印）: 玉置さんの印（画像）が貼付されているか
- G14（合計金額）: 請求書PDFの合計と一致するか（数式 `=W43` で自動計算）
- C19（明細タイトル）: 「yyyy年mm月作業費」形式になっているか（数式 `=TEXT(注文書!$AC$2,"yyyy年ｍｍ月作業費")` で自動計算）
- AA19（摘要）: 見積書の見積書番号になっているか（数式 `=注文書!AA17` で自動計算）
- W20〜（金額）: 数式 `=T{n}*R{n}` で自動計算されているか
- W41（小計）: 請求書PDFの小計と一致するか（数式 `=SUM(W18:Z40)` で自動計算）
- W42（消費税）: 請求書PDFの消費税額合計と一致するか（数式 `=ROUNDDOWN(W41*0.1,0)` で自動計算）
- W43（合計金額）: 請求書PDFの合計と一致するか（数式 `=W41+W42` で自動計算）

### 6. PDF生成

- 注文書シートを `注文書_YYMM.pdf` として出力
- 検収書シートを `検収書_YYMM.pdf` として出力

### 7. ZIP生成

- `オフ・ビート・ワークス_YYMM.zip` を生成（Excel + 注文書PDF + 検収書PDF）

---

# 共通ルール

## 取引先判別（ファイル名から）

| 取引先 | 判別条件 |
|--------|----------|
| ネクストビッツ | ファイル名が `TRR-` で始まる |
| オフ・ビート・ワークス | ファイル名に `offbeat-to-terra` を含む |

## 注文番号サフィックス

| 取引先 | サフィックス |
|--------|-------------|
| ネクストビッツ | `-01` |
| オフ・ビート・ワークス | `-02` |

## 検収日の自動計算

`=EOMONTH(注文書!$AC$2,0)` は発行日の月の最終日を返す。土日祝日でもその日付のまま。

## ZIP内容

出力ファイル3つのみを含む：
- Excel
- 注文書PDF
- 検収書PDF

## チェック不一致時の処理

金額チェックで不一致の場合はエラーとして処理を中止し、エラー情報をDBに記録する。

---

**作成日**: 2025-12-08
**最終更新**: 2025-12-08
