# 月次処理自動化システム 要件定義書

**バージョン**: 1.0
**作成日**: 2025-10-06
**最終更新**: 2025-10-07
**ステータス**: 確定

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [成果定義](#2-成果定義)
3. [システム要件](#3-システム要件)
4. [機能要件](#4-機能要件)
5. [非機能要件](#5-非機能要件)
6. [技術スタック](#6-技術スタック)
7. [データベース設計](#7-データベース設計)
8. [外部サービス](#8-外部サービス)
9. [セキュリティ要件](#9-セキュリティ要件)
10. [開発・デプロイ環境](#10-開発デプロイ環境)

---

## 1. プロジェクト概要

### 1.1 システム名
**月次処理自動化システム**

### 1.2 目的
毎月25日～翌月5日に受領する4種類のPDF（見積書・請求書・注文請書・納品書）を自動処理し、取引先ごとのExcelファイル編集とPDF生成を自動化することで、月次業務の工数を90%削減する。

### 1.3 対象ユーザー
- 社内スタッフ（管理者・一般ユーザー）
- 招待制による限定的なアクセス

### 1.4 対象取引先
- **現在**: ネクストビッツ様、オフビートワークス様
- **将来**: 追加可能な設計

---

## 2. 成果定義

### 2.1 成果の詳細定義

毎月25日～翌月5日に受領する4種類のPDF（見積書・請求書・注文請書・納品書）を事前チェックし、取引先を自動判別、先月分のExcel（注文書・検収書）を各社の処理ルールに従って自動編集。処理結果（ExcelファイルとPDF 2種）を1分以内で出力し、DBに永久保存。ログイン機能により過去の処理結果をいつでもダウンロード可能。管理者と一般ユーザーの権限分離に対応した業務自動化システム。

### 2.2 定量的指標

| 指標 | 目標値 |
|------|--------|
| **処理時間削減** | 手作業10分 → 自動化1分以内（90%削減） |
| **エラー事前検知率** | 100%（処理開始前に問題検知・通知） |
| **処理成功率** | 100%（事前チェック通過後） |
| **月間工数削減** | 取引先2社で月20分程度削減 |

### 2.3 定性的指標

- **脱属人化**: マニュアルを見ずに誰でも実行可能
- **ストレスフリー**: 定型業務から解放され創造的業務に集中できる
- **安心感**: 事前チェックで問題を検知し、エラーなく処理完了
- **トレーサビリティ**: 過去の処理結果をいつでも参照・再ダウンロード可能
- **将来対応**: ユーザー増加・取引先追加に柔軟に対応可能

---

## 3. システム要件

### 3.1 システム構成

```
[ユーザー]
    ↓
[React Frontend (AWS Amplify)]
    ↓ REST API
[Node.js API (AWS Lambda)]
    ↓ 処理委譲
[Python PDF/Excel処理 (AWS Lambda)]
    ↓
[Supabase PostgreSQL]
 ├─ 認証（Supabase Auth）
 ├─ ユーザー・権限管理
 ├─ ファイル保存（BYTEA型）
 └─ 処理ログ・エラーログ
```

### 3.2 対応ブラウザ

- Google Chrome（最新版）
- Microsoft Edge（最新版）
- Firefox（最新版）
- Safari（最新版）

### 3.3 動作環境

- **フロントエンド**: モダンブラウザ（ES2020対応）
- **バックエンド**: AWS Lambda（Node.js 20 + Python 3.11）
- **データベース**: PostgreSQL 15（Supabase）

---

## 4. 機能要件

### 4.1 ページ構成（全8ページ）

#### 認証関連ページ（3ページ）

##### P-001a: ログインページ
- **権限**: ゲスト（未ログイン）
- **機能**:
  - メールアドレス + パスワード入力
  - ログイン状態保持チェックボックス
  - パスワードリセットリンク

##### P-001b: 招待受諾・パスワード設定ページ
- **権限**: 招待リンク保有者
- **機能**:
  - メールアドレス表示（変更不可）
  - パスワード設定（8文字以上）
  - パスワード確認入力

##### P-001c: パスワードリセットページ
- **権限**: パスワードリセットリンク保有者
- **機能**:
  - 新パスワード設定（8文字以上）
  - パスワード確認入力

---

#### メイン機能ページ（5ページ）

##### P-002: PDF処理実行ページ
- **権限**: 全ユーザー
- **機能**:
  - 4つのPDF統合アップロード（見積書・請求書・注文請書・納品書）
  - 自動判別（取引先特定）
  - 事前チェック（フォーマット検証・データ確認）
  - 初回のみExcelアップロード（2回目以降は自動取得）
  - 処理実行（プログレスバー表示）
  - 処理完了後の即時ダウンロード（Excel・注文書PDF・検収書PDF）

**画面遷移**:
```
初期状態（PDFドロップゾーン）
  ↓ 4つのPDFをドロップ
判別中（自動判別実行）
  ↓
判別完了・事前チェック完了
  ↓ [初回のみ] Excelアップロード
処理実行可能
  ↓ [処理を実行]ボタン
処理中（プログレスバー）
  ↓
処理完了（ダウンロードボタン表示）
```

##### P-003: 処理履歴・ダウンロードページ
- **権限**: 全ユーザー（全員が全データ閲覧可能）
- **機能**:
  - 処理履歴一覧表示（取引先名・処理日・処理者・状態）
  - フィルター機能（取引先・期間・処理者）
  - ファイル再ダウンロード（Excel・注文書PDF・検収書PDF）
  - 処理時間表示
  - エラー詳細表示（モーダル）

##### P-004: ユーザー管理ページ（管理者専用）
- **権限**: 管理者専用
- **機能**:
  - ユーザー一覧表示（メールアドレス・ロール・登録日）
  - 新規ユーザー招待（モーダル）
  - ユーザー削除（確認モーダル）
  - 権限変更（即座に適用）

**保護機能**:
- 自分自身の編集ブロック
- 最終管理者の削除/降格ブロック

##### P-005: 取引先設定ページ（管理者専用）
- **権限**: 管理者専用
- **機能**:
  - 取引先一覧表示
  - 取引先詳細表示・編集
  - テンプレートExcelの確認・ダウンロード・更新
  - 処理ルール表示（読み取り専用）
  - 処理履歴確認

**処理ルールの管理**:
- Phase 1（MVP）: 開発者がコード修正
- Phase 2（将来）: 設定ファイル方式
- Phase 3（将来）: GUI設定画面

---

### 4.2 認証・権限設計

#### ユーザーロール

| ロール | 権限 |
|--------|------|
| **管理者** | ・ユーザー管理（招待・削除・権限変更）<br>・処理実行<br>・全ユーザーのデータ閲覧・ダウンロード<br>・処理ログ閲覧<br>・エラーログ閲覧<br>・取引先設定管理 |
| **一般ユーザー** | ・処理実行<br>・全ユーザーのデータ閲覧・ダウンロード<br>・処理ログ閲覧<br>・エラーログ閲覧 |

**注**: 管理者と一般ユーザーの実質的な違いは「ユーザー管理機能」と「取引先設定管理機能」のみ

#### 認証方式

- **招待制**: 管理者が招待メール送信 → ユーザーがパスワード設定
- メール + パスワード認証
- パスワード自動ハッシュ化（bcrypt）
- JWTトークンベースのセッション管理
- Row Level Security（データベースレベルの権限制御）

#### 認証フロー

**初回登録**:
```
管理者が招待 → 招待メール受信 → リンククリック
→ パスワード設定 → 登録完了 → 自動ログイン
```

**2回目以降**:
```
ログインページ → メール + パスワード入力 → ログイン
```

---

### 4.3 PDF処理ルール

#### 処理対象ファイル

| ファイル種別 | 必須 | 用途 |
|------------|------|------|
| 見積書 | ✅ | データ抽出元 |
| 請求書 | ✅ | データ抽出元 |
| 注文請書 | ✅ | データ抽出元 |
| 納品書 | ✅ | データ抽出元 |

#### 処理フロー

```
1. PDFアップロード（4ファイル）
   ↓
2. 取引先自動判別（PDF内容から特定）
   ↓
3. 事前チェック
   - フォーマット検証
   - データ存在確認
   - 金額整合性チェック
   ↓
4. 前回Excelの取得
   - 初回: 手動アップロード → DB保存
   - 2回目以降: DB自動取得
   ↓
5. Excel自動編集
   - 処理ルールに従ってデータ転記
   - 数式はそのまま保持
   ↓
6. PDF生成
   - 注文書PDF
   - 検収書PDF
   ↓
7. DB保存 + ダウンロード提供
```

#### 処理ルール例（ネクストビッツ様）

**自動計算項目（Excelの数式）**:
- 注文番号: yyyymmdd-01 形式
- 注文書明細タイトル: yyyy年mm月作業費
- 金額: 数量 × 単価
- 摘要: 見積番号：***-**-*** 形式

**PDF→Excel転記**:
- 発行日: 前回+1ヶ月の1日
- 発注金額: 請求書の合計金額
- 件名: 見積書の件名（パターン変換）
- 数量: 見積書の数量（1式→1に変換）
- 単価: 見積書の単価
- 小計・消費税・合計: 請求書と一致チェック

**固定値チェック**:
- 宛名: 株式会社ネクストビッツ 御中
- 明細の締め: 以下、余白

---

## 5. 非機能要件

### 5.1 性能要件

| 項目 | 要件 |
|------|------|
| **処理時間** | 1分以内（PDF解析→Excel編集→PDF生成） |
| **同時実行** | 5ユーザーまで同時処理可能 |
| **ファイルサイズ** | PDF 1ファイルあたり最大10MB |
| **レスポンスタイム** | 画面遷移2秒以内 |

### 5.2 可用性要件

| 項目 | 要件 |
|------|------|
| **稼働率** | 99.5%以上 |
| **バックアップ** | データベース日次自動バックアップ |
| **障害復旧** | 24時間以内 |

### 5.3 保守性要件

- コードレビュー実施
- 単体テスト・統合テスト実施
- E2Eテスト実施
- TypeScript型安全性確保
- ESLint/Prettierによるコード品質管理

### 5.4 拡張性要件

- 取引先追加に対応可能な設計
- ユーザー数増加に対応可能な設計
- 処理ルール変更に対応可能な設計

---

## 6. 技術スタック

### 6.1 フロントエンド

| 技術 | バージョン | 用途 |
|------|----------|------|
| React | 18 | UIフレームワーク |
| TypeScript | 5.x | 型安全性 |
| Vite | 5.x | ビルドツール |
| Tailwind CSS | 3.x | スタイリング |
| shadcn/ui | latest | UIコンポーネント |
| Zustand | latest | 状態管理 |
| Supabase Auth UI | latest | 認証UI |

### 6.2 バックエンド

| 技術 | バージョン | 用途 |
|------|----------|------|
| Node.js | 20 | ランタイム |
| Express | 4.x | APIフレームワーク |
| TypeScript | 5.x | 型安全性 |
| Python | 3.11 | PDF/Excel処理 |
| pdfplumber | latest | PDF解析 |
| openpyxl | latest | Excel編集 |
| LibreOffice | latest | PDF生成 |

### 6.3 データベース

| 技術 | バージョン | 用途 |
|------|----------|------|
| PostgreSQL | 15 | RDBMS |
| Supabase | latest | DBホスティング + 認証 |

### 6.4 インフラ

| 技術 | 用途 |
|------|------|
| AWS Amplify | フロントエンドホスティング |
| AWS Lambda Docker Image | バックエンド実行環境 |
| Supabase | データベース + 認証 |

---

## 7. データベース設計

### 7.1 テーブル定義

#### profiles（ユーザープロファイル）

```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  email TEXT NOT NULL,
  role TEXT CHECK (role IN ('admin', 'user')) DEFAULT 'user',
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```


#### processed_files（処理済みファイル）

```sql
CREATE TABLE processed_files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id),
  company_id UUID REFERENCES companies(id),
  process_date DATE NOT NULL,

  -- ファイルをバイナリで保存
  excel_file BYTEA NOT NULL,
  excel_filename TEXT NOT NULL,
  order_pdf BYTEA NOT NULL,
  order_pdf_filename TEXT NOT NULL,
  inspection_pdf BYTEA NOT NULL,
  inspection_pdf_filename TEXT NOT NULL,

  -- 処理情報
  processing_time INTEGER, -- 秒
  status TEXT CHECK (status IN ('success', 'error')),
  error_message TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### process_logs（処理ログ）

```sql
CREATE TABLE process_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id),
  company_id UUID REFERENCES companies(id),
  status TEXT CHECK (status IN ('success', 'error')),
  error_message TEXT,
  error_detail TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### companies（取引先）- テンプレートExcel含む

```sql
CREATE TABLE companies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  display_name TEXT NOT NULL, -- 宛名（Excel表記）
  is_active BOOLEAN DEFAULT TRUE,
  last_processed_at TIMESTAMPTZ,

  -- テンプレートExcel（最新版のみ保持）
  template_excel BYTEA,
  template_filename TEXT,
  template_updated_at TIMESTAMPTZ,
  template_updated_by UUID REFERENCES profiles(id),

  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**注**: テンプレートExcelは履歴を残さず、最新版のみ保持します。

---

## 8. 外部サービス

### 8.1 使用する外部サービス（3つ）

#### Supabase 🔐
- **用途**: データベース + 認証
- **機能**:
  - PostgreSQL 15データベース
  - Supabase Auth（招待制ユーザー管理）
  - Row Level Security（権限制御）
  - ファイルストレージ（BYTEA型でDB保存）
- **無料枠**: 10,000 MAU、500MB DB
- **月額費用**: $0
- **必要タイミング**: 開発開始時から（ローカル開発でも使用）

#### AWS Amplify ☁️
- **用途**: フロントエンドホスティング
- **機能**:
  - Git連携自動デプロイ
  - HTTPS対応
  - CDN配信
- **無料枠**: 月1,000ビルド分、5GB転送
- **月額費用**: $0
- **必要タイミング**: Phase 10（デプロイメント）のみ

#### AWS Lambda ⚡
- **用途**: バックエンドAPI + PDF/Excel処理
- **機能**:
  - サーバーレス実行環境
  - Docker Image対応（LibreOffice実行）
  - 自動スケーリング
- **無料枠**: 100万リクエスト/月
- **月額費用**: $0
- **必要タイミング**: Phase 10（デプロイメント）のみ

### 8.2 外部API不要な項目

以下は外部APIを**使用しません**（自前実装）:

- ❌ PDF解析API → pdfplumberで自前実装
- ❌ Excel編集API → openpyxlで自前実装
- ❌ PDF生成API → LibreOfficeで自前実装
- ❌ ファイルストレージサービス → PostgreSQL BYTEA型で保存
- ❌ メール送信サービス → Supabase Auth内蔵機能を使用

---

## 9. セキュリティ要件

### 9.1 認証・認可

- 招待制による厳格なアクセス制御
- パスワードの自動ハッシュ化（bcrypt）
- JWTトークンベースのセッション管理
- Row Level Security（RLS）によるデータベースレベルの権限制御

### 9.2 データ保護

- HTTPS通信（全通信暗号化）
- パスワードの不可逆暗号化
- ファイルはデータベース内に保存（URLリンクでの直接アクセス不可、ログイン後にのみダウンロード可能）

### 9.3 脆弱性対策

- XSS対策（React自動エスケープ）
- CSRF対策（JWTトークン）
- SQLインジェクション対策（プリペアドステートメント）
- 依存ライブラリの定期的な脆弱性チェック

---

## 10. 開発・デプロイ環境

### 10.1 ローカル開発環境

```yaml
フロントエンド:
  - npm run dev (Vite開発サーバー)
  - localhost:5173 (例)
  - AWS Amplify不要

バックエンド:
  - npm run dev (Node.js Express)
  - localhost:3000 (例)
  - AWS Lambda不要
  - Dockerも不要（通常のNode.js + Python）

データベース:
  - Supabase無料プロジェクト（リモート接続）
```

**Phase 1-9まではローカルで完全に開発・テスト可能。AWSは最後のデプロイ時のみ使用。**

### 10.2 本番環境

```yaml
フロントエンド:
  - AWS Amplify
  - Git連携自動デプロイ
  - HTTPS対応

バックエンド:
  - AWS Lambda Docker Image
  - Docker Image (Node.js + Python + LibreOffice)
  - 初回起動: 5〜10秒（コールドスタート）

データベース:
  - Supabase PostgreSQL
  - 自動バックアップ
```

### 10.3 月額費用

```
AWS Amplify: $0（無料枠内）
AWS Lambda: $0（100万リクエスト/月無料）
Supabase: $0（無料枠内）

合計: $0/月
```

---

## 付録A: 用語集

| 用語 | 定義 |
|------|------|
| **コールドスタート** | Lambda関数が初めて起動する際の待ち時間（5〜10秒） |
| **Row Level Security (RLS)** | データベースレベルでのアクセス制御機能 |
| **BYTEA型** | PostgreSQLのバイナリデータ型（ファイル保存用） |
| **JWT** | JSON Web Token（認証トークン形式） |
| **MAU** | Monthly Active Users（月間アクティブユーザー数） |

---

## 付録B: 開発フェーズ

| Phase | 名称 | 概要 |
|-------|------|------|
| Phase 1 | 要件定義 | ✅ 完了 |
| Phase 2 | Git/GitHub管理 | リポジトリ準備 |
| Phase 3 | フロントエンド基盤 | React+Vite基盤構築 |
| Phase 4 | ページ実装 | 8ページ実装 |
| Phase 5 | 環境構築 | Supabase設定 |
| Phase 6 | バックエンド計画 | 実装順序計画 |
| Phase 7 | バックエンド実装 | API実装 |
| Phase 8 | API統合 | フロントエンド連携 |
| Phase 9 | E2Eテスト | 品質担保 |
| Phase 10 | デプロイメント | AWS本番デプロイ |

---

**文書管理**:
- 本要件定義書は確定版です
- 変更が発生した場合はバージョンを更新してください
- 質問・不明点は開発チームまでお問い合わせください

---

**承認**:
- 作成者: BlueLamp要件定義エンジニア
- レビュー者: -
- 承認者: -
- 承認日: -
