# 月次処理自動化システム 要件定義書

**バージョン**: 2.2
**作成日**: 2025-10-06
**最終更新**: 2025-12-03
**ステータス**: 確定

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [成果定義](#2-成果定義)
3. [システム要件](#3-システム要件)
4. [機能要件](#4-機能要件)
5. [非機能要件](#5-非機能要件)
6. [技術スタック](#6-技術スタック)
7. [データベース設計](#7-データベース設計)
8. [外部サービス](#8-外部サービス)
9. [セキュリティ要件](#9-セキュリティ要件)
10. [開発・デプロイ環境](#10-開発デプロイ環境)
11. [付録A: 用語集](#付録a-用語集)
12. [付録B: 開発フェーズ](#付録b-開発フェーズ)
13. [付録C: 変更履歴](#付録c-変更履歴)

---

## 1. プロジェクト概要

### 1.1 システム名
**月次処理自動化システム**

### 1.2 目的
毎月25日～翌月5日に受領する4種類のPDF（見積書・請求書・注文請書・納品書）を自動処理し、取引先ごとのExcelファイル編集とPDF生成を自動化することで、月次業務の工数を90%削減する。

### 1.3 対象ユーザー
- 社内スタッフ（管理者・一般ユーザー）
- 招待制による限定的なアクセス

### 1.4 対象取引先
- **現在**: ネクストビッツ様、オフビートワークス様
- **将来**: 追加可能な設計

---

## 2. 成果定義

### 2.1 成果の詳細定義

毎月25日～翌月5日に受領する4種類のPDF（見積書・請求書・注文請書・納品書）を事前チェックし、取引先を自動判別、先月分のExcel（注文書・検収書）を各社の処理ルールに従って自動編集。処理結果（ExcelファイルとPDF 2種）を1分以内で出力し、DBに永久保存。ログイン機能により過去の処理結果をいつでもダウンロード可能。管理者と一般ユーザーの権限分離に対応した業務自動化システム。

### 2.2 定量的指標

| 指標 | 目標値 |
|------|--------|
| **処理時間削減** | 手作業10分 → 自動化1分以内（90%削減） |
| **エラー事前検知率** | 100%（処理開始前に問題検知・通知） |
| **処理成功率** | 100%（事前チェック通過後） |
| **月間工数削減** | 取引先2社で月20分程度削減 |

### 2.3 定性的指標

- **脱属人化**: マニュアルを見ずに誰でも実行可能
- **ストレスフリー**: 定型業務から解放され創造的業務に集中できる
- **安心感**: 事前チェックで問題を検知し、エラーなく処理完了
- **トレーサビリティ**: 過去の処理結果をいつでも参照・再ダウンロード可能
- **将来対応**: ユーザー増加・取引先追加に柔軟に対応可能

---

## 3. システム要件

### 3.1 システム構成

```
[ユーザー]
    ↓
[React Frontend (AWS Amplify)]
    ↓ REST API
[Node.js API (AWS Lambda)]
    ↓ 処理委譲
[Python PDF/Excel処理 (AWS Lambda)]
    ↓
[Supabase PostgreSQL]
 ├─ 認証（Supabase Auth）
 ├─ ユーザー・権限管理
 ├─ ファイル保存（BYTEA型）
 └─ 処理ログ・エラーログ
```

### 3.2 対応ブラウザ

- Google Chrome（最新版）
- Microsoft Edge（最新版）
- Firefox（最新版）
- Safari（最新版）

### 3.3 動作環境

- **フロントエンド**: モダンブラウザ（ES2020対応）
- **バックエンド**: AWS Lambda（Node.js 20 + Python 3.11）
- **データベース**: PostgreSQL 15（Supabase）

---

## 4. 機能要件

### 4.1 ページ構成（全7ページ）

#### 認証関連ページ（3ページ）

##### P-001a: ログインページ
- **権限**: ゲスト（未ログイン）
- **機能**:
  - メールアドレス + パスワード入力
  - ログイン状態保持チェックボックス
  - パスワードリセットリンク

##### P-001b: 招待受諾・パスワード設定ページ
- **権限**: 招待リンク保有者
- **機能**:
  - メールアドレス表示（変更不可）
  - パスワード設定（英字・数字を含む8文字以上）
  - パスワード確認入力

##### P-001c: パスワードリセットページ
- **権限**: ゲスト（未ログイン）
- **機能**: 2ステップフロー
  - **ステップ1**: メールアドレス入力
    - メールアドレス入力フィールド
    - リセットリンク送信ボタン
    - ログインページに戻るボタン
  - **ステップ2**: 新パスワード設定（`?step=password`）
    - 新パスワード入力（英字・数字を含む8文字以上）
    - パスワード確認入力

---

#### メイン機能ページ（4ページ）

##### P-002: PDF処理実行ページ
- **権限**: 全ユーザー
- **機能**:
  - 4つのPDF統合アップロード（見積書・請求書・注文請書・納品書）
  - 自動判別（取引先特定）
  - 事前チェック（フォーマット検証・データ確認）
  - 初回のみExcelアップロード（2回目以降は自動取得）
  - 処理実行（プログレスバー表示）
  - 処理完了後の即時ダウンロード（Excel・注文書PDF・検収書PDF）

**PDFアップロード方式**:
- **まとめてアップロード**: ドラッグ&ドロップまたは「まとめて選択」ボタンで複数ファイル一括アップロード
- **個別アップロード**: 各スロット（見積書・請求書・注文請書・納品書）ごとに「ファイルを選択」ボタンで個別アップロード
- **スロット管理**: 4種類のPDFスロットで不足ファイルを視覚的に表示（OK/未設定ステータス）

**PDF種別判別ルール**:
- ファイル名に「見積」を含む → 見積書
- ファイル名に「請書」を含む → 注文請書（「請求」より優先判定）
- ファイル名に「請求」を含む → 請求書
- ファイル名に「納品」を含む → 納品書
- 個別スロットへのアップロード時、判別種別とスロット種別が不一致の場合はエラー

**取引先判別ルール（ファイル名の命名規則）**:

| 取引先 | 判別キーワード | 命名規則 |
|--------|---------------|---------|
| ネクストビッツ | `TRR-` で始まる | `TRR-YY-MMM_種別.pdf`（例: TRR-25-011_お見積書.pdf） |
| オフビートワークス | `offbeat-to-terra` を含む | 種別ごとに異なる（下記参照） |

**ネクストビッツ様の命名規則**:
| 種別 | パターン | 例 |
|------|---------|-----|
| 見積書 | `TRR-YY-MMM_お見積書.pdf` | TRR-25-011_お見積書.pdf |
| 請求書 | `TRR-YY-MMM_請求書.pdf` | TRR-25-011_請求書.pdf |
| 注文請書 | `TRR-YY-MMM_注文請書.pdf` | TRR-25-011_注文請書.pdf |
| 納品書 | `TRR-YY-MMM_納品書.pdf` | TRR-25-011_納品書.pdf |

※ YY=年2桁、MMM=月3桁ゼロ埋め（例: 011=11月）

**オフビートワークス様の命名規則**:
| 種別 | パターン | 例 |
|------|---------|-----|
| 見積書 | `1NNNNNN見積-offbeat-to-terra-YYYYMM.pdf` | 1951030見積-offbeat-to-terra-202511.pdf |
| 請求書 | `2NNNNNN-請求_offbeat-to-terra-YYYYMM.pdf` | 2951030-請求_offbeat-to-terra-202511.pdf |
| 納品書 | `3NNNNNN-納品-offbeat-to-terra-YYYYMM.pdf` | 3951030-納品-offbeat-to-terra-202511.pdf |
| 注文請書 | `請書-offbeat-to-terra-YYYYMM.pdf` | 請書-offbeat-to-terra-202511.pdf |

※ NNNNNN=書類番号6桁（連番ではない）、YYYYMM=年月

**取引先混在検知**:
- アップロードされた4ファイルの取引先が混在している場合はエラー表示

**ドラッグ&ドロップUI**:
- カード全体がドロップゾーン
- ドラッグ中は白色半透明オーバーレイ（85%）で後ろのコンテンツを薄く表示
- 中央にアップロードアイコンと「ここにドロップ」テキスト表示

**エラー表示ルール**:
- 成功通知・軽微なエラー: Snackbar（画面下部、自動消去）
- 重要な警告（種別不一致等）: ダイアログ（OKボタンで閉じる）

**画面遷移**:
```
初期状態（PDFドロップゾーン）
  ↓ 4つのPDFをドロップ
判別中（自動判別実行）
  ↓
判別完了・事前チェック完了
  ├─ 不足ファイルあり → スロット管理画面で個別追加可能
  └─ 全ファイル揃い → 処理実行可能
  ↓ [初回のみ] Excelアップロード
処理実行可能
  ↓ [処理を実行]ボタン
処理中（プログレスバー）
  ↓
処理完了（ダウンロードボタン表示）
```

##### P-003: 処理履歴・ダウンロードページ
- **権限**: 全ユーザー（全員が全データ閲覧可能）
- **機能**:
  - 処理履歴一覧表示（取引先名・処理日・処理者・状態・ファイル一括DL）
  - フィルター機能（取引先・期間・処理者・並び順）
    - 取引先フィルター: 処理履歴に存在する取引先のみ表示
    - 無効な取引先: 「取引先名（無効）」とグレーで表示
    - 期間フィルター: 単一の日付範囲ピッカー（開始日〜終了日）
    - 処理者フィルター: 削除済みユーザーも含めて表示
    - 削除済みユーザーは「メールアドレス（削除済み）」と表示し、グレーで視覚的に区別
    - 並び順: 最新順/古い順
  - ファイル再ダウンロード
    - 一括ダウンロード（Excel・注文書PDF・検収書PDF をZIP形式）
    - 個別ダウンロード（詳細モーダルから各ファイル単体）
  - 処理詳細モーダル（行クリックで表示）
    - 基本情報（処理日・取引先・処理者）
    - 使用したファイル（入力PDF 4種）の表示
    - 生成されたファイル（Excel・注文書PDF・検収書PDF）の個別ダウンロード
  - エラー詳細モーダル（エラー行クリックで表示）
    - 視覚的なエラーアイコンヘッダー
    - 処理情報（処理日・取引先・処理者）
    - エラーメッセージ
    - 技術的詳細（エラーコード・ファイル名・スタックトレース）

**削除済みユーザーの扱い**:
- 処理履歴一覧の「処理者」列: 削除済みユーザーは「メールアドレス（削除済み）」とグレー表示
- 削除されたユーザーが過去に処理したデータは保持され、引き続き閲覧・ダウンロード可能

**無効な取引先の扱い**:
- 処理履歴一覧の「取引先名」列: 無効な取引先は「取引先名（無効）」とグレー表示
- 無効化された取引先の過去の処理データは保持され、引き続き閲覧・ダウンロード可能

##### P-004: ユーザー管理ページ（管理者専用）
- **権限**: 管理者専用
- **機能**:
  - ユーザー一覧表示（メールアドレス・ロール・登録日）
  - 新規ユーザー招待（モーダル）
  - ユーザー削除（確認モーダル、論理削除）
  - 権限変更（即座に適用）

**保護機能**:
- 最終管理者（管理者が1人のみの場合）の削除/降格ブロック

**論理削除の仕様**:
- ユーザー削除は物理削除ではなく論理削除（`is_deleted = true`）
- 削除されたユーザーはログインできなくなる
- 過去の処理履歴は保持され、処理者名も引き続き表示される
- 削除済みユーザーはP-004のユーザー一覧には表示されない（MVPでは復元機能なし）

##### P-005: 取引先設定ページ（管理者専用）
- **権限**: 管理者専用
- **機能**:
  - 取引先一覧表示
  - 取引先詳細表示・編集
  - テンプレートExcelの確認・ダウンロード・更新
  - 処理ルール表示（読み取り専用）
  - 処理履歴確認

**処理ルールの管理**:
- Phase 1（MVP）: 開発者がコード修正
- Phase 2（将来）: 設定ファイル方式
- Phase 3（将来）: GUI設定画面

---

### 4.2 認証・権限設計

#### ユーザーロール

| ロール | 権限 |
|--------|------|
| **管理者** | ・ユーザー管理（招待・削除・権限変更）<br>・処理実行<br>・全ユーザーのデータ閲覧・ダウンロード<br>・処理ログ閲覧<br>・エラーログ閲覧<br>・取引先設定管理 |
| **一般ユーザー** | ・処理実行<br>・全ユーザーのデータ閲覧・ダウンロード<br>・処理ログ閲覧<br>・エラーログ閲覧 |

**注**: 管理者と一般ユーザーの実質的な違いは「ユーザー管理機能」と「取引先設定管理機能」のみ

#### 認証方式

- **招待制**: 管理者が招待メール送信 → ユーザーがパスワード設定
- メール + パスワード認証
- パスワード自動ハッシュ化（bcrypt）
- JWTトークンベースのセッション管理
- Row Level Security（データベースレベルの権限制御）

#### 認証フロー

**初回登録**:
```
管理者が招待 → 招待メール受信 → リンククリック
→ パスワード設定 → 登録完了 → ログインページへ遷移 → ログイン
```

**2回目以降**:
```
ログインページ → メール + パスワード入力 → ログイン
```

---

### 4.3 PDF処理ルール

#### 処理対象ファイル

| ファイル種別 | 必須 | 用途 |
|------------|------|------|
| 見積書 | ✅ | データ抽出元 |
| 請求書 | ✅ | データ抽出元 |
| 注文請書 | ✅ | データ抽出元 |
| 納品書 | ✅ | データ抽出元 |

#### 処理フロー

```
1. PDFアップロード（4ファイル）
   ↓
2. 取引先自動判別（PDF内容から特定）
   ↓
3. 事前チェック
   - フォーマット検証
   - データ存在確認
   - 金額整合性チェック
   ↓
4. 前回Excelの取得
   - 初回: 手動アップロード → DB保存
   - 2回目以降: DB自動取得
   ↓
5. Excel自動編集
   - 処理ルールに従ってデータ転記
   - 数式はそのまま保持
   ↓
6. PDF生成
   - 注文書PDF
   - 検収書PDF
   ↓
7. DB保存 + ダウンロード提供
```

#### 処理ルール例（ネクストビッツ様）

**自動計算項目（Excelの数式）**:
- 注文番号: yyyymmdd-01 形式
- 注文書明細タイトル: yyyy年mm月作業費
- 金額: 数量 × 単価
- 摘要: 見積番号：***-**-*** 形式

**PDF→Excel転記**:
- 発行日: 前回+1ヶ月の1日
- 発注金額: 請求書の合計金額
- 件名: 見積書の件名（パターン変換）
- 数量: 見積書の数量（1式→1に変換）
- 単価: 見積書の単価
- 小計・消費税・合計: 請求書と一致チェック

**固定値チェック**:
- 宛名: 株式会社ネクストビッツ 御中
- 明細の締め: 以下、余白

---

## 5. 非機能要件

### 5.1 性能要件

| 項目 | 要件 |
|------|------|
| **処理時間** | 1分以内（PDF解析→Excel編集→PDF生成） |
| **同時実行** | 5ユーザーまで同時処理可能 |
| **ファイルサイズ** | PDF 1ファイルあたり最大10MB |
| **レスポンスタイム** | 画面遷移2秒以内 |

### 5.2 可用性要件

| 項目 | 要件 |
|------|------|
| **稼働率** | 99.5%以上 |
| **バックアップ** | データベース日次自動バックアップ |
| **障害復旧** | 24時間以内 |

### 5.3 保守性要件

- コードレビュー実施
- 単体テスト・統合テスト実施
- E2Eテスト実施
- TypeScript型安全性確保
- ESLint/Prettierによるコード品質管理

### 5.4 拡張性要件

- 取引先追加に対応可能な設計
- ユーザー数増加に対応可能な設計
- 処理ルール変更に対応可能な設計

---

## 6. 技術スタック

### 6.1 フロントエンド

| 技術 | バージョン | 用途 |
|------|----------|------|
| React | 18 | UIフレームワーク |
| TypeScript | 5.x | 型安全性 |
| Vite | 5.x | ビルドツール |
| Tailwind CSS | 3.x | スタイリング |
| shadcn/ui | latest | UIコンポーネント |
| Zustand | latest | 状態管理 |
| Supabase Auth UI | latest | 認証UI |

### 6.2 バックエンド

| 技術 | バージョン | 用途 |
|------|----------|------|
| Node.js | 20 | ランタイム |
| Express | 4.x | APIフレームワーク |
| TypeScript | 5.x | 型安全性 |
| Python | 3.11 | PDF/Excel処理 |
| pdfplumber | latest | PDF解析 |
| openpyxl | latest | Excel編集 |
| LibreOffice | latest | PDF生成 |

### 6.3 データベース

| 技術 | バージョン | 用途 |
|------|----------|------|
| PostgreSQL | 15 | RDBMS |
| Supabase | latest | DBホスティング + 認証 |

### 6.4 インフラ

| 技術 | 用途 |
|------|------|
| AWS Amplify | フロントエンドホスティング |
| AWS Lambda Docker Image | バックエンド実行環境 |
| Supabase | データベース + 認証 |

---

## 7. データベース設計

### 7.1 テーブル定義

#### profiles（ユーザープロファイル）

```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  email TEXT NOT NULL,
  role TEXT CHECK (role IN ('admin', 'user')) DEFAULT 'user',
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**論理削除について**:
- `is_deleted = true` のユーザーはログイン不可
- 過去の処理履歴（processed_files, process_logs）は保持され、ユーザー名も表示される
- 取引先テーブル（companies）の `template_updated_by` も保持される
- Row Level Security (RLS) で `is_deleted = false` のユーザーのみログイン可能に制御


#### processed_files（処理済みファイル）

```sql
CREATE TABLE processed_files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id),
  company_id UUID REFERENCES companies(id),
  process_date DATE NOT NULL,

  -- ファイルをバイナリで保存
  excel_file BYTEA NOT NULL,
  excel_filename TEXT NOT NULL,
  order_pdf BYTEA NOT NULL,
  order_pdf_filename TEXT NOT NULL,
  inspection_pdf BYTEA NOT NULL,
  inspection_pdf_filename TEXT NOT NULL,

  -- 処理情報
  processing_time INTEGER, -- 秒
  status TEXT CHECK (status IN ('success', 'error')),
  error_message TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### process_logs（処理ログ）

```sql
CREATE TABLE process_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id),
  company_id UUID REFERENCES companies(id),
  status TEXT CHECK (status IN ('success', 'error')),
  error_message TEXT,
  error_detail TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### companies（取引先）- テンプレートExcel含む

```sql
CREATE TABLE companies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  display_name TEXT NOT NULL, -- 宛名（Excel表記）
  is_active BOOLEAN DEFAULT TRUE,
  last_processed_at TIMESTAMPTZ,

  -- テンプレートExcel（最新版のみ保持）
  template_excel BYTEA,
  template_filename TEXT,
  template_updated_at TIMESTAMPTZ,
  template_updated_by UUID REFERENCES profiles(id),

  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**注**: テンプレートExcelは履歴を残さず、最新版のみ保持します。

---

## 8. 外部サービス

### 8.1 使用する外部サービス（3つ）

#### Supabase 🔐
- **用途**: データベース + 認証
- **機能**:
  - PostgreSQL 15データベース
  - Supabase Auth（招待制ユーザー管理）
  - Row Level Security（権限制御）
  - ファイルストレージ（BYTEA型でDB保存）
- **無料枠**: 10,000 MAU、500MB DB
- **月額費用**: $0
- **必要タイミング**: 開発開始時から（ローカル開発でも使用）

#### AWS Amplify ☁️
- **用途**: フロントエンドホスティング
- **機能**:
  - Git連携自動デプロイ
  - HTTPS対応
  - CDN配信
- **無料枠**: 月1,000ビルド分、5GB転送
- **月額費用**: $0
- **必要タイミング**: Phase 10（デプロイメント）のみ

#### AWS Lambda ⚡
- **用途**: バックエンドAPI + PDF/Excel処理
- **機能**:
  - サーバーレス実行環境
  - Docker Image対応（LibreOffice実行）
  - 自動スケーリング
- **無料枠**: 100万リクエスト/月
- **月額費用**: $0
- **必要タイミング**: Phase 10（デプロイメント）のみ

### 8.2 外部API不要な項目

以下は外部APIを**使用しません**（自前実装）:

- ❌ PDF解析API → pdfplumberで自前実装
- ❌ Excel編集API → openpyxlで自前実装
- ❌ PDF生成API → LibreOfficeで自前実装
- ❌ ファイルストレージサービス → PostgreSQL BYTEA型で保存
- ❌ メール送信サービス → Supabase Auth内蔵機能を使用

---

## 9. セキュリティ要件

### 9.1 認証・認可

- 招待制による厳格なアクセス制御
- パスワードの自動ハッシュ化（bcrypt）
- JWTトークンベースのセッション管理
- Row Level Security（RLS）によるデータベースレベルの権限制御

### 9.2 データ保護

- HTTPS通信（全通信暗号化）
- パスワードの不可逆暗号化
- ファイルはデータベース内に保存（URLリンクでの直接アクセス不可、ログイン後にのみダウンロード可能）

### 9.3 脆弱性対策

- XSS対策（React自動エスケープ）
- CSRF対策（JWTトークン）
- SQLインジェクション対策（プリペアドステートメント）
- 依存ライブラリの定期的な脆弱性チェック

---

## 10. 開発・デプロイ環境

### 10.1 ローカル開発環境

```yaml
フロントエンド:
  - npm run dev (Vite開発サーバー)
  - localhost:5173 (例)
  - AWS Amplify不要

バックエンド:
  - npm run dev (Node.js Express)
  - localhost:3000 (例)
  - AWS Lambda不要
  - Dockerも不要（通常のNode.js + Python）

データベース:
  - Supabase無料プロジェクト（リモート接続）
```

**Phase 1-9まではローカルで完全に開発・テスト可能。AWSは最後のデプロイ時のみ使用。**

### 10.2 本番環境

```yaml
フロントエンド:
  - AWS Amplify
  - Git連携自動デプロイ
  - HTTPS対応

バックエンド:
  - AWS Lambda Docker Image
  - Docker Image (Node.js + Python + LibreOffice)
  - 初回起動: 5〜10秒（コールドスタート）

データベース:
  - Supabase PostgreSQL
  - 自動バックアップ
```

### 10.3 月額費用

```
AWS Amplify: $0（無料枠内）
AWS Lambda: $0（100万リクエスト/月無料）
Supabase: $0（無料枠内）

合計: $0/月
```

---

## 付録A: 用語集

| 用語 | 定義 |
|------|------|
| **コールドスタート** | Lambda関数が初めて起動する際の待ち時間（5〜10秒） |
| **Row Level Security (RLS)** | データベースレベルでのアクセス制御機能 |
| **BYTEA型** | PostgreSQLのバイナリデータ型（ファイル保存用） |
| **JWT** | JSON Web Token（認証トークン形式） |
| **MAU** | Monthly Active Users（月間アクティブユーザー数） |

---

## 付録B: 開発フェーズ

| Phase | 名称 | 概要 |
|-------|------|------|
| Phase 1 | 要件定義 | ✅ 完了 |
| Phase 2 | Git/GitHub管理 | リポジトリ準備 |
| Phase 3 | フロントエンド基盤 | React+Vite基盤構築 |
| Phase 4 | ページ実装 | 8ページ実装 |
| Phase 5 | 環境構築 | Supabase設定 |
| Phase 6 | バックエンド計画 | 実装順序計画 |
| Phase 7 | バックエンド実装 | API実装 |
| Phase 8 | API統合 | フロントエンド連携 |
| Phase 9 | E2Eテスト | 品質担保 |
| Phase 10 | デプロイメント | AWS本番デプロイ |

---

## 付録C: 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2025-12-03 | 2.2 | P-001c UI改善・P-004 招待機能改善<br>- P-001c: 「ログインページに戻る」ボタンの視認性向上（`text-primary hover:underline`スタイル適用）<br>- P-004: 既存ユーザーへの招待ブロック機能追加（「このメールアドレスは既に登録されています」エラー表示）<br>- P-004: 削除済みユーザーへの再招待は許可（退職→再入社のケースに対応）<br>- 理由: ユーザビリティ向上と招待機能の整合性確保 | - |
| 2025-12-03 | 2.1 | モックデータ整合性改善・P-005 UI改善<br>- P-005: 取引先詳細ダイアログからタイトル（「取引先詳細 - {会社名}」）を削除（下部に表示名があるため冗長）<br>- P-005: 処理履歴タブを削除（P-003で閲覧可能なため冗長）<br>- P-003: 取引先フィルターをcompaniesServiceと連携（取引先設定で管理している会社のみ表示）<br>- P-003: 処理者フィルターをusersServiceと連携（ユーザー管理のデータと同期）<br>- P-003: 無効な取引先は一覧・詳細モーダルで「（無効）」付きグレー表示に（companiesService参照）<br>- P-003: 削除済みユーザーは一覧・詳細モーダルで「（削除済み）」付きグレー表示に（usersService参照）<br>- historyService: モックデータの整合性修正（user_idをusersServiceと一致、テスト商事削除）<br>- usersService: getAllUsersIncludingDeleted()関数追加（削除済みユーザー含む全ユーザー取得）<br>- 理由: モック間のデータ整合性確保、Phase 7のAPI統合準備 | - |
| 2025-12-03 | 2.0 | Phase 4完了・P-004機能改善<br>- P-002: 処理完了時のFadeアニメーション追加（0.6秒）<br>- P-004: 自分自身のロール変更禁止機能を追加（「自分自身のロールは変更できません。他の管理者に依頼してください。」ダイアログ表示）<br>- P-004: ロール変更時の認証ストア同期機能を追加（変更後の再ログイン時に正しいロールを反映）<br>- API仕様書作成: P-002（process-api.md）、P-004（users-api.md）<br>- E2Eテスト仕様書作成: P-002（process-e2e.md）、P-004（users-e2e.md）<br>- P-003仕様書をapi-specs/e2e-specsフォルダに移動・整理<br>- 理由: モック動作の整合性確保とPhase 7以降の実装準備 | - |
| 2025-12-02 | 1.9 | P-002 UI/UX改善<br>- Excelテンプレートアップロード時のファイル名検証を追加（取引先名必須: ネクストビッツ/オフ・ビート・ワークス）<br>- 取引先表示をh6タイポグラフィに変更<br>- 処理完了時の「処理が完了しました」メッセージをCard外に移動<br>- 処理完了時のSnackbar通知を削除（画面上の表示と重複のため）<br>- 処理完了画面のDividerを削除<br>- Excelファイル形式エラーをSnackbar表示に統一（PDF形式エラーと同様）<br>- Excelテンプレートアップロード後もドラッグ&ドロップで差し替え可能に変更<br>- Excelテンプレートアップロードエラー時に再アップロード画面へ正しく遷移するよう修正<br>- 理由: 操作性向上と視覚的フィードバックの改善 | - |
| 2025-12-01 | 1.8 | P-002機能詳細化（Phase 4実装による仕様反映）<br>- ページ構成: 「全8ページ」→「全7ページ」に修正<br>- ページ構成: 「メイン機能ページ（5ページ）」→「メイン機能ページ（4ページ）」に修正<br>- P-002: PDFアップロード方式を追加（まとめて/個別アップロード）<br>- P-002: スロット管理機能を追加（4種類のPDFスロットで不足ファイル表示）<br>- P-002: PDF種別判別ルールを追加（ファイル名キーワードによる自動判別）<br>- P-002: 「請書」キーワードを「請求」より優先判定に設定<br>- P-002: 個別スロットへのアップロード時の種別検証を追加<br>- P-002: 取引先判別ルール（命名規則）を追加（ネクストビッツ様・オフビートワークス様）<br>- P-002: 取引先混在検知機能を追加<br>- P-002: ドラッグ&ドロップUI仕様を追加（オーバーレイ表示）<br>- P-002: エラー表示ルールを追加（Snackbar/ダイアログの使い分け）<br>- P-002: 画面遷移に不足ファイル時の分岐を追加<br>- 理由: ユーザビリティ向上と操作性改善のため、および実装との整合性確保 | - |
| 2025-10-16 | 1.6 | P-003機能詳細化（Phase 4実装による仕様反映）<br>- P-003: 処理時間表示を削除<br>- P-003: 使用したファイル（入力PDF 4種）表示機能を追加<br>- P-003: ファイル一括ダウンロード（ZIP形式）機能を追加<br>- P-003: 処理詳細モーダル（行クリック）を追加<br>- P-003: エラー詳細モーダルの構造化（視覚的アイコン・処理情報・技術的詳細）<br>- P-003: 期間フィルターを単一の日付範囲ピッカーに変更<br>- P-003: 無効な取引先の扱い（グレー表示）を追加<br>- P-003: 並び順（最新順/古い順）フィルターを追加<br>- 理由: ユーザビリティ向上とトレーサビリティ強化のため | - |
| 2025-10-10 | 1.5 | 論理削除仕様の追加<br>- P-004: 保護機能から「自分自身の編集ブロック」を削除（最終管理者のみ保護）<br>- P-004: ユーザー削除を論理削除で実装（`is_deleted`フラグ使用）<br>- P-003: 削除済みユーザーのフィルター表示・視覚的区別を追加<br>- profiles: `is_deleted`, `deleted_at` カラム追加<br>- 理由: スタッフ移動時の権限引き継ぎを可能にし、履歴データの整合性を保つため | - |
| 2025-10-08 | 1.4 | UI実装方針の明確化<br>- P-001c: 「ログインページに戻るリンク」→「ログインページに戻るボタン」に変更<br>- 理由: React Routerの`navigate()`を使用した`<button type="button">`で実装する方針を明確化 | - |
| 2025-10-08 | 1.3 | 認証フローの修正<br>- 初回登録: 「自動ログイン」→「ログインページへ遷移 → ログイン」に変更<br>- 理由: セキュリティ向上（パスワードをメモリに保持しない） | - |
| 2025-10-08 | 1.2 | P-001c仕様の明確化<br>- P-001c: 2ステップフロー（メールアドレス入力→新パスワード設定）を明記<br>- 権限を「パスワードリセットリンク保有者」→「ゲスト（未ログイン）」に修正 | - |
| 2025-10-08 | 1.1 | パスワード要件強化（英字・数字必須化）<br>- P-001b: パスワード設定要件を「8文字以上」→「英字・数字を含む8文字以上」に変更<br>- P-001c: パスワード設定要件を「8文字以上」→「英字・数字を含む8文字以上」に変更 | - |
| 2025-10-07 | 1.0 | 初版確定 | - |

---

**文書管理**:
- 本要件定義書は確定版です
- 変更が発生した場合はバージョンを更新してください
- 質問・不明点は開発チームまでお問い合わせください

---

**承認**:
- 作成者: BlueLamp要件定義エンジニア
- レビュー者: -
- 承認者: -
- 承認日: -
