# ユーザー管理E2Eテスト仕様書 (P-004)

**生成日**: 2025-12-03
**最終更新**: 2025-12-04
**対象ページ**: P-004 (ユーザー管理ページ)
**テスト環境**: Playwright

---

## 📋 テスト概要

P-004 ユーザー管理ページのE2Eテスト仕様を定義します。

### テスト対象URL
```
http://localhost:5174/users
```

### 前提条件
- 管理者（admin）ユーザーとしてログイン済み
- 一般ユーザーはこのページにアクセス不可

---

## 🧪 テストケース一覧

### 1. 正常系テスト

#### TC-001: ユーザー一覧表示
```yaml
前提条件:
  - 管理者としてログイン
  - 複数のユーザーが登録済み

手順:
  1. /users にアクセス

期待結果:
  - ページタイトル「ユーザー管理」が表示される
  - ユーザー一覧テーブルが表示される
  - 各ユーザーのメールアドレス・ロール・登録日が表示される
  - 「新規ユーザーを招待」ボタンが表示される
```

#### TC-002: 新規ユーザー招待
```yaml
手順:
  1. /users にアクセス
  2. 「新規ユーザーを招待」ボタンをクリック
  3. 招待モーダルが表示されることを確認
  4. メールアドレス入力: newuser@example.com
  5. ロール選択: 一般ユーザー
  6. 「招待メールを送信」ボタンをクリック

期待結果:
  - Snackbarで「招待メールを送信しました」と表示される
  - モーダルが閉じる
  - ユーザー一覧に新しいユーザーが追加される（モック動作）
```

#### TC-003: 管理者として招待
```yaml
手順:
  1. 「新規ユーザーを招待」ボタンをクリック
  2. メールアドレス入力: newadmin@example.com
  3. ロール選択: 管理者
  4. 「招待を送信」ボタンをクリック

期待結果:
  - 新しい管理者ユーザーが追加される
  - ロール列に「管理者」と表示される
```

#### TC-004: ロール変更（一般ユーザー → 管理者）
```yaml
前提条件:
  - 一般ユーザーが存在する

手順:
  1. 一般ユーザーの行でロール列のドロップダウンをクリック
  2. 「管理者」を選択

期待結果:
  - Snackbarで「ロールを変更しました」と表示される
  - ロール列が「管理者」に更新される
```

#### TC-005: ロール変更（管理者 → 一般ユーザー）
```yaml
前提条件:
  - 管理者が2人以上存在する

手順:
  1. 管理者ユーザーの行でロール列のドロップダウンをクリック
  2. 「一般ユーザー」を選択

期待結果:
  - Snackbarで「ロールを変更しました」と表示される
  - ロール列が「一般ユーザー」に更新される
```

#### TC-006: ユーザー削除
```yaml
前提条件:
  - 削除対象ユーザーが最終管理者でない

手順:
  1. 削除対象ユーザーの行で「削除」ボタンをクリック
  2. 確認ダイアログが表示されることを確認
  3. 「削除」ボタンをクリック

期待結果:
  - Snackbarで「ユーザーを削除しました」と表示される
  - ユーザー一覧から該当ユーザーが消える
```

#### TC-007: 削除キャンセル
```yaml
手順:
  1. ユーザーの「削除」ボタンをクリック
  2. 確認ダイアログで「キャンセル」をクリック

期待結果:
  - ダイアログが閉じる
  - ユーザーは削除されない
```

---

### 2. 異常系テスト

#### TC-101: 最終管理者の削除拒否
```yaml
前提条件:
  - 管理者が1人のみ

手順:
  1. 最終管理者の「削除」ボタンをクリック

期待結果:
  - ダイアログで「最終管理者のため削除できません」と表示される
  - 削除は実行されない
```

#### TC-102: 最終管理者の降格拒否
```yaml
前提条件:
  - 管理者が1人のみ

手順:
  1. 最終管理者のロールドロップダウンで「一般ユーザー」を選択

期待結果:
  - ダイアログで「最終管理者のため降格できません」と表示される
  - ロールは変更されない
```

#### TC-103: 空のメールアドレスで招待
```yaml
手順:
  1. 「新規ユーザーを招待」ボタンをクリック
  2. メールアドレスを空のまま
  3. 「招待を送信」ボタンをクリック

期待結果:
  - バリデーションエラーで「メールアドレスを入力してください」と表示される
  - 招待は送信されない
```

#### TC-104: 不正なメールアドレス形式
```yaml
手順:
  1. 「新規ユーザーを招待」ボタンをクリック
  2. メールアドレス入力: invalid-email
  3. 「招待を送信」ボタンをクリック

期待結果:
  - バリデーションエラーで「メールアドレスの形式が不正です」と表示される
```

#### TC-105: 自分自身のロール変更拒否
```yaml
前提条件:
  - 管理者（admin@example.com）としてログイン

手順:
  1. 自分自身（admin@example.com）の行でロール列のドロップダウンをクリック
  2. 「一般ユーザー」を選択

期待結果:
  - ダイアログで「自分自身のロールは変更できません。他の管理者に依頼してください。」と表示される
  - ロールは変更されない
```

#### TC-106: 既存ユーザーへの招待ブロック
```yaml
前提条件:
  - admin@example.com が既に登録済み

手順:
  1. 「新規ユーザーを招待」ボタンをクリック
  2. メールアドレス入力: admin@example.com
  3. 「招待を送信」ボタンをクリック

期待結果:
  - Snackbarで「このメールアドレスは既に登録されています」と表示される
  - 招待は送信されない
```

#### TC-107: 削除済みユーザーへの再招待は許可
```yaml
前提条件:
  - deleted@example.com が論理削除済み

手順:
  1. 「新規ユーザーを招待」ボタンをクリック
  2. メールアドレス入力: deleted@example.com
  3. 「招待を送信」ボタンをクリック

期待結果:
  - Snackbarで「招待メールを送信しました」と表示される
  - ユーザー一覧に deleted@example.com が追加される（モック動作）
```

---

### 3. 権限テスト

#### TC-201: 一般ユーザーのアクセス拒否
```yaml
前提条件:
  - 一般ユーザー（role: user）としてログイン

手順:
  1. /users に直接アクセス

期待結果:
  - 「アクセス権限がありません」エラー、またはリダイレクト
  - ユーザー管理ページは表示されない
```

#### TC-202: 未認証アクセス
```yaml
前提条件:
  - ログアウト状態

手順:
  1. /users に直接アクセス

期待結果:
  - /login にリダイレクトされる
```

---

### 4. UI/UXテスト

#### TC-301: 招待モーダルのキーボード操作
```yaml
手順:
  1. 「新規ユーザーを招待」ボタンをクリック
  2. Escキーを押す

期待結果:
  - モーダルが閉じる
```

#### TC-302: 通知の自動消去
```yaml
手順:
  1. ユーザーを招待
  2. Snackbar通知を確認
  3. 3秒待機

期待結果:
  - Snackbar通知が自動的に消える
```

#### TC-303: ロール変更の即時反映
```yaml
手順:
  1. ユーザーのロールを変更

期待結果:
  - ページリロードなしでロールが更新される
  - 他の操作が可能なまま
```

#### TC-304: ローディング状態
```yaml
手順:
  1. 「新規ユーザーを招待」で招待送信

期待結果:
  - 送信中はボタンがローディング状態になる
  - 二重送信が防止される
```

---

### 5. レスポンシブテスト

#### TC-401: デスクトップ表示 (1920x1080)
```yaml
確認項目:
  - テーブルが全幅で表示される
  - すべての列が表示される
  - アクションボタンが横並び
```

#### TC-402: タブレット表示 (768x1024)
```yaml
確認項目:
  - テーブルが適切にスクロール可能
  - モーダルが画面内に収まる
```

#### TC-403: モバイル表示 (375x667)
```yaml
確認項目:
  - テーブルが横スクロール可能
  - モーダルがフルスクリーンに近い表示
  - タップ操作が適切に機能
```

#### TC-404: 削除ダイアログのレスポンシブ対応
```yaml
前提条件:
  - モバイルサイズ（375x667）で表示

手順:
  1. ユーザーの「削除」ボタンをクリック
  2. 確認ダイアログを確認

期待結果:
  - ボタンが縦並びで表示される
  - 「キャンセル」が下、「削除」が上に配置される
  - ボタンが全幅表示される
```

---

### 6. データ整合性テスト

#### TC-501: 削除済みユーザーの非表示
```yaml
前提条件:
  - ユーザーを削除済み

手順:
  1. /users にアクセス

期待結果:
  - 削除済みユーザーは一覧に表示されない
```

#### TC-502: 削除済みユーザーの処理履歴保持
```yaml
前提条件:
  - ユーザーAが処理を実行
  - ユーザーAを削除

手順:
  1. /history にアクセス
  2. ユーザーAが実行した処理を確認

期待結果:
  - 処理履歴は保持される
  - 処理者列に「メールアドレス（削除済み）」と表示される
```

---

## 📁 テストデータ

### 初期ユーザー
| メールアドレス | ロール |
|---------------|--------|
| admin@example.com | 管理者 |
| admin2@example.com | 管理者 |
| user@example.com | 一般ユーザー |

### テスト用招待メールアドレス
| メールアドレス | 用途 |
|---------------|------|
| newuser@example.com | 一般ユーザー招待テスト |
| newadmin@example.com | 管理者招待テスト |
| invalid-email | 不正形式テスト |

---

## 🔗 関連ドキュメント

| ドキュメント | パス |
|-------------|------|
| API仕様書 | `docs/api-specs/users-api.md` |
| 要件定義書 | `docs/requirements.md` (P-004セクション) |
| モックサービス | `frontend/src/services/mock/usersService.ts` |
