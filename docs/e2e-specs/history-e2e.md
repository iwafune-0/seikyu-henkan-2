# P-003: 処理履歴・ダウンロードページ - E2Eテスト仕様書

**作成日**: 2025-10-17
**最終更新**: 2025-12-04
**フェーズ**: Phase 4（ページ実装）
**実装予定**: Phase 9（E2Eテスト）

---

## 1. 概要

P-003（処理履歴・ダウンロードページ）のE2Eテスト仕様書です。Phase 9でPlaywrightによる自動テストを実装する際に参照します。

---

## 2. テスト環境

- **ブラウザ**: Chromium, Firefox, WebKit（Playwright）
- **デバイス**: Desktop（1920x1080）, Tablet（768x1024）, Mobile（375x667）
- **認証**: テストユーザーでログイン済み

---

## 3. テストケース一覧

| テストID | テスト名 | 優先度 |
|---------|---------|-------|
| E2E-P003-001 | ページの初期表示 | 高 |
| E2E-P003-002 | 処理履歴一覧の表示 | 高 |
| E2E-P003-003 | レスポンシブ対応（テーブル↔カード切り替え） | 高 |
| E2E-P003-004 | 取引先フィルター | 中 |
| E2E-P003-005 | 処理者フィルター | 中 |
| E2E-P003-006 | 状態フィルター | 中 |
| E2E-P003-007 | 期間フィルター | 中 |
| E2E-P003-008 | 並び順フィルター | 中 |
| E2E-P003-009 | 処理詳細モーダル表示 | 高 |
| E2E-P003-010 | エラー詳細モーダル表示 | 高 |
| E2E-P003-011 | 個別ファイルダウンロード | 高 |
| E2E-P003-012 | ZIP一括ダウンロード | 高 |
| E2E-P003-013 | 削除済みユーザーのグレー表示 | 低 |
| E2E-P003-014 | 無効な取引先のグレー表示 | 低 |

---

## 4. テストケース詳細

### E2E-P003-001: ページの初期表示

**目的**: ページが正しく表示されることを確認

**前提条件**:
- ログイン済み
- 処理履歴データが1件以上存在

**手順**:
1. サイドバーから「処理履歴・ダウンロード」をクリック
2. ページが表示されることを確認

**期待結果**:
- ページタイトル「処理履歴・ダウンロード」が表示される
- フィルターエリアが表示される
- 処理履歴一覧（テーブルまたはカード）が表示される

---

### E2E-P003-002: 処理履歴一覧の表示

**目的**: 処理履歴一覧が正しく表示されることを確認

**前提条件**:
- ログイン済み
- 処理履歴データが複数件存在

**手順**:
1. ページにアクセス
2. 処理履歴一覧が表示されることを確認

**期待結果**:
- 処理履歴が新しい順（デフォルト）で表示される
- 各レコードに以下が表示される:
  - 取引先名
  - 処理日時
  - 処理者
  - 状態（成功/エラー）
  - ZIP一括ダウンロードボタン（成功時のみ）

---

### E2E-P003-003: レスポンシブ対応（テーブル↔カード切り替え）

**目的**: レスポンシブ対応が正しく動作することを確認

**前提条件**:
- ログイン済み
- 処理履歴データが1件以上存在

**手順**:
1. デスクトップ（1920x1080）でページにアクセス
2. テーブル表示されることを確認
3. タブレット（768x1024）にサイズ変更
4. カードレイアウトに切り替わることを確認
5. モバイル（375x667）にサイズ変更
6. カードレイアウトが表示されることを確認

**期待結果**:
- デスクトップ（1024px以上）: テーブル表示
- タブレット・モバイル（1024px未満）: カードレイアウト表示
- データの内容は同一

---

### E2E-P003-004: 取引先フィルター

**目的**: 取引先フィルターが正しく動作することを確認

**前提条件**:
- ログイン済み
- 複数の取引先の処理履歴が存在

**手順**:
1. ページにアクセス
2. 取引先フィルターで「ネクストビッツ」を選択
3. 一覧が更新されることを確認

**期待結果**:
- 「ネクストビッツ」の処理履歴のみが表示される
- 他の取引先の処理履歴は表示されない

---

### E2E-P003-005: 処理者フィルター

**目的**: 処理者フィルターが正しく動作することを確認

**前提条件**:
- ログイン済み
- 複数のユーザーの処理履歴が存在

**手順**:
1. ページにアクセス
2. 処理者フィルターで特定のユーザーを選択
3. 一覧が更新されることを確認

**期待結果**:
- 選択したユーザーの処理履歴のみが表示される
- 他のユーザーの処理履歴は表示されない

---

### E2E-P003-006: 状態フィルター

**目的**: 状態フィルターが正しく動作することを確認

**前提条件**:
- ログイン済み
- 成功とエラーの処理履歴が存在

**手順**:
1. ページにアクセス
2. 状態フィルターで「成功」を選択
3. 成功した処理のみが表示されることを確認
4. 状態フィルターで「エラー」を選択
5. エラーが発生した処理のみが表示されることを確認

**期待結果**:
- 「成功」選択時: 成功した処理のみ表示
- 「エラー」選択時: エラーが発生した処理のみ表示

---

### E2E-P003-007: 期間フィルター

**目的**: 期間フィルターが正しく動作することを確認

**前提条件**:
- ログイン済み
- 異なる日付の処理履歴が存在

**手順**:
1. ページにアクセス
2. 期間（開始）に「2025-10-01」を入力
3. 期間（終了）に「2025-10-31」を入力
4. 一覧が更新されることを確認

**期待結果**:
- 2025-10-01〜2025-10-31の処理履歴のみが表示される
- 期間外の処理履歴は表示されない

---

### E2E-P003-008: 並び順フィルター

**目的**: 並び順フィルターが正しく動作することを確認

**前提条件**:
- ログイン済み
- 処理履歴データが複数件存在

**手順**:
1. ページにアクセス（デフォルト: 新しい順）
2. 最新の処理が一番上に表示されることを確認
3. 並び順フィルターで「古い順」を選択
4. 一覧が逆順で表示されることを確認

**期待結果**:
- 新しい順: 最新の処理が一番上
- 古い順: 最も古い処理が一番上

---

### E2E-P003-009: 処理詳細モーダル表示

**目的**: 処理詳細モーダルが正しく表示されることを確認

**前提条件**:
- ログイン済み
- 成功した処理履歴が存在

**手順**:
1. ページにアクセス
2. 成功した処理のレコードをクリック
3. 処理詳細モーダルが表示されることを確認
4. 各ファイルダウンロードボタンをクリック
5. ダウンロードが実行されることを確認
6. ×ボタンでモーダルを閉じる

**期待結果**:
- 処理詳細モーダルが表示される
- モーダルタイトル「処理詳細 - {取引先名} {処理日}」が表示される
- 以下が横並びレイアウトで表示される:
  - 取引先: {取引先名}
  - 処理日: {処理日}
  - 処理者: {処理者}
- 生成ファイル一覧（Excel、注文書PDF、検収書PDF）
- 使用したファイル一覧（入力PDF1〜4）
- 各ファイルダウンロードボタンをクリックするとダウンロードが実行される
- ×ボタンでモーダルが閉じる

---

### E2E-P003-010: エラー詳細モーダル表示

**目的**: エラー詳細モーダルが正しく表示されることを確認

**前提条件**:
- ログイン済み
- エラーが発生した処理履歴が存在

**手順**:
1. ページにアクセス
2. エラーが発生した処理のレコードをクリック
3. エラー詳細モーダルが表示されることを確認
4. エラー情報が表示されることを確認
5. ×ボタンでモーダルを閉じる

**期待結果**:
- エラー詳細モーダルが表示される
- モーダルタイトル「エラー詳細 - {取引先名} {処理日}」が表示される
- 以下が横並びレイアウトで表示される:
  - 取引先: {取引先名}
  - 処理日: {処理日}
  - 処理者: {処理者}
- エラー情報が表示される:
  - エラーメッセージ
  - エラーコード
  - エラー詳細
  - スタックトレース
- ×ボタンでモーダルが閉じる

---

### E2E-P003-011: 個別ファイルダウンロード

**目的**: 個別ファイルダウンロードが正しく動作することを確認

**前提条件**:
- ログイン済み
- 成功した処理履歴が存在

**手順**:
1. ページにアクセス
2. 成功した処理のレコードをクリック
3. 処理詳細モーダルが表示される
4. 「ネクストビッツ_2025-10-15.xlsx」ボタンをクリック
5. ダウンロードが実行されることを確認

**期待結果**:
- ファイルがダウンロードされる
- Snackbar「ファイルをダウンロードしました」が表示される
- Snackbarが3秒後に自動的に閉じる

---

### E2E-P003-012: ZIP一括ダウンロード

**目的**: ZIP一括ダウンロードが正しく動作することを確認

**前提条件**:
- ログイン済み
- 成功した処理履歴が存在

**手順**:
1. ページにアクセス
2. 成功した処理のレコードの「ZIP」ボタンをクリック
3. ダウンロードが実行されることを確認

**期待結果**:
- ZIPファイルがダウンロードされる
- Snackbar「ZIPファイルをダウンロードしました」が表示される
- Snackbarが3秒後に自動的に閉じる

---

### E2E-P003-013: 削除済みユーザーのグレー表示

**目的**: 削除済みユーザーがグレー表示されることを確認

**前提条件**:
- ログイン済み
- 削除済みユーザーの処理履歴が存在

**手順**:
1. ページにアクセス
2. 削除済みユーザーの処理履歴を確認

**期待結果**:
- 削除済みユーザーのメールアドレスがグレー表示（色: #9e9e9e、イタリック体）
- 例: `deleted@example.com (削除済み)`

---

### E2E-P003-014: 無効な取引先のグレー表示

**目的**: 無効な取引先がグレー表示されることを確認

**前提条件**:
- ログイン済み
- 無効な取引先の処理履歴が存在

**手順**:
1. ページにアクセス
2. 無効な取引先の処理履歴を確認

**期待結果**:
- 無効な取引先名がグレー表示（色: #9e9e9e、イタリック体）
- 例: `テスト商事（無効）`

---

## 5. Playwright実装例

### 5.1. テストケース E2E-P003-001

```typescript
import { test, expect } from '@playwright/test'

test('E2E-P003-001: ページの初期表示', async ({ page }) => {
  // ログイン
  await page.goto('/login')
  await page.fill('input[type="email"]', 'admin@example.com')
  await page.fill('input[type="password"]', 'password')
  await page.click('button[type="submit"]')

  // 処理履歴ページに移動
  await page.click('text=処理履歴・ダウンロード')
  await expect(page).toHaveURL(/\/history/)

  // ページタイトルの確認
  await expect(page.locator('h1')).toHaveText('処理履歴・ダウンロード')

  // フィルターエリアの確認
  await expect(page.locator('text=取引先')).toBeVisible()
  await expect(page.locator('text=処理者')).toBeVisible()
  await expect(page.locator('text=状態')).toBeVisible()

  // 処理履歴一覧の確認
  await expect(page.locator('table, .history-card').first()).toBeVisible()
})
```

### 5.2. テストケース E2E-P003-003

```typescript
import { test, expect } from '@playwright/test'

test('E2E-P003-003: レスポンシブ対応', async ({ page }) => {
  // ログイン
  await page.goto('/login')
  await page.fill('input[type="email"]', 'admin@example.com')
  await page.fill('input[type="password"]', 'password')
  await page.click('button[type="submit"]')

  // 処理履歴ページに移動
  await page.goto('/history')

  // デスクトップ（1920x1080）: テーブル表示
  await page.setViewportSize({ width: 1920, height: 1080 })
  await expect(page.locator('table')).toBeVisible()
  await expect(page.locator('.history-card')).not.toBeVisible()

  // タブレット（768x1024）: カード表示
  await page.setViewportSize({ width: 768, height: 1024 })
  await expect(page.locator('table')).not.toBeVisible()
  await expect(page.locator('.history-card').first()).toBeVisible()

  // モバイル（375x667）: カード表示
  await page.setViewportSize({ width: 375, height: 667 })
  await expect(page.locator('table')).not.toBeVisible()
  await expect(page.locator('.history-card').first()).toBeVisible()
})
```

### 5.3. テストケース E2E-P003-009

```typescript
import { test, expect } from '@playwright/test'

test('E2E-P003-009: 処理詳細モーダル表示', async ({ page }) => {
  // ログイン
  await page.goto('/login')
  await page.fill('input[type="email"]', 'admin@example.com')
  await page.fill('input[type="password"]', 'password')
  await page.click('button[type="submit"]')

  // 処理履歴ページに移動
  await page.goto('/history')

  // 成功した処理をクリック
  await page.click('table tr:has-text("成功")')

  // モーダルが表示される
  await expect(page.locator('h2:has-text("処理詳細")')).toBeVisible()
  await expect(page.locator('text=取引先')).toBeVisible()
  await expect(page.locator('text=処理日')).toBeVisible()
  await expect(page.locator('text=処理者')).toBeVisible()
  await expect(page.locator('text=生成ファイル')).toBeVisible()
  await expect(page.locator('text=使用したファイル')).toBeVisible()

  // ×ボタンでモーダルを閉じる
  await page.click('[aria-label="close"]')
  await expect(page.locator('h2:has-text("処理詳細")')).not.toBeVisible()
})
```

---

## 6. カバレッジ目標

- **ページカバレッジ**: 100%（全ページテスト）
- **機能カバレッジ**: 80%以上（主要機能テスト）
- **デバイスカバレッジ**: Desktop + Mobile最低限

---

## 7. 実装時の注意点

### 7.1. ダウンロードテスト

Playwrightでダウンロードをテストする場合は、以下のようにします：

```typescript
// ダウンロードを監視
const downloadPromise = page.waitForEvent('download')
await page.click('text=ネクストビッツ_2025-10-15.xlsx')
const download = await downloadPromise

// ダウンロードされたファイル名を確認
expect(download.suggestedFilename()).toBe('ネクストビッツ_2025-10-15.xlsx')
```

### 7.2. フィルター動作の待機

フィルターを変更した後、データが更新されるまで待機する必要があります：

```typescript
await page.selectOption('select#companyFilter', 'ネクストビッツ')
await page.waitForLoadState('networkidle') // API呼び出し完了を待つ
```

### 7.3. Snackbar表示確認

Snackbarが自動で消えるため、表示後すぐに確認する必要があります：

```typescript
await page.click('text=ZIPボタン')
await expect(page.locator('text=ZIPファイルをダウンロードしました')).toBeVisible()
await expect(page.locator('text=ZIPファイルをダウンロードしました')).not.toBeVisible({ timeout: 5000 })
```

---

## 8. Phase 9での実装タスク

1. **テストファイル作成**:
   - `e2e/p003-history-page.spec.ts` - 全テストケース実装

2. **テストデータ準備**:
   - テスト用の処理履歴データ作成
   - 削除済みユーザー、無効な取引先のデータ作成

3. **CI/CD統合**:
   - GitHubActions設定
   - テスト自動実行

---

**作成者**: Claude Code
**レビュー**: 未実施
**承認**: 未実施
