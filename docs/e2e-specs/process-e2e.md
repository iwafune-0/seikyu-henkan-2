# PDF処理E2Eテスト仕様書 (P-002)

**生成日**: 2025-12-03
**対象ページ**: P-002 (PDF処理実行ページ)
**テスト環境**: Playwright

---

## 📋 テスト概要

P-002 PDF処理実行ページのE2Eテスト仕様を定義します。

### テスト対象URL
```
http://localhost:5174/process
```

### 前提条件
- ログイン済みユーザー（一般ユーザーまたは管理者）
- テスト用PDFファイル（4種類）が用意されている

---

## 🧪 テストケース一覧

### 1. 正常系テスト

#### TC-001: ネクストビッツ - 初回処理フロー
```yaml
前提条件:
  - ネクストビッツのテンプレートExcelがDBに存在しない（初回）
  - テスト用PDFファイル4つ準備
    - TRR-25-011_お見積書.pdf
    - TRR-25-011_請求書.pdf
    - TRR-25-011_注文請書.pdf
    - TRR-25-011_納品書.pdf

手順:
  1. /process にアクセス
  2. 「PDFファイルをドラッグ&ドロップ」エリアに4つのPDFをドロップ
  3. 取引先「株式会社ネクストビッツ」が自動判別されることを確認
  4. 全スロットが「OK」になることを確認
  5. Excelテンプレートアップロード画面が表示されることを確認
  6. テンプレートExcel（テラ【株式会社ネクストビッツ御中】注文検収書_2511.xlsx）をアップロード
  7. 「処理を実行」ボタンをクリック
  8. プログレスバーが0%→100%に進行することを確認
  9. 「処理が完了しました」がフェードインで表示されることを確認
  10. 生成されたファイル一覧が表示されることを確認

期待結果:
  - 取引先: 株式会社ネクストビッツ
  - 生成ファイル:
    - テラ【株式会社ネクストビッツ御中】注文検収書_YYMM.xlsx
    - 注文書_YYMM.pdf
    - 検収書_YYMM.pdf
  - 一括ダウンロード（ZIP）ボタンが表示される
  - 新規処理を開始ボタンが表示される
```

#### TC-002: ネクストビッツ - 2回目以降の処理フロー
```yaml
前提条件:
  - ネクストビッツのテンプレートExcelがDBに存在する（2回目以降）
  - テスト用PDFファイル4つ準備

手順:
  1. /process にアクセス
  2. 4つのPDFをアップロード
  3. 取引先が自動判別されることを確認
  4. Excelテンプレートアップロード画面が表示されないことを確認
  5. 「処理を実行」ボタンが即座に表示されることを確認
  6. 処理を実行

期待結果:
  - Excelアップロードをスキップして処理実行可能
  - 処理完了後、ファイルダウンロード可能
```

#### TC-003: オフビートワークス - 処理フロー
```yaml
前提条件:
  - テスト用PDFファイル4つ準備
    - 1951030見積-offbeat-to-terra-202511.pdf
    - 2951030-請求_offbeat-to-terra-202511.pdf
    - 請書-offbeat-to-terra-202511.pdf
    - 3951030-納品-offbeat-to-terra-202511.pdf

手順:
  1. /process にアクセス
  2. 4つのPDFをアップロード
  3. 取引先「株式会社オフビートワークス」が自動判別されることを確認

期待結果:
  - 正しく取引先が判別される
  - 処理が正常に完了する
```

#### TC-004: 個別スロットへのファイルアップロード
```yaml
前提条件:
  - 1つのPDFのみ準備

手順:
  1. /process にアクセス
  2. 見積書PDFをドロップ
  3. 見積書スロットが「OK」、他は「未設定」になることを確認
  4. 請求書スロットの「ファイルを選択」ボタンをクリック
  5. 請求書PDFを選択
  6. 請求書スロットが「OK」になることを確認
  7. 残り2つも同様に追加

期待結果:
  - 各スロットに個別にファイルを追加可能
  - 全スロット「OK」で処理実行可能
```

#### TC-005: ファイルの削除と再アップロード
```yaml
手順:
  1. 4つのPDFをアップロード
  2. 見積書スロットの「×」ボタンをクリック
  3. 見積書スロットが「未設定」になることを確認
  4. 新しい見積書PDFをアップロード
  5. 見積書スロットが「OK」になることを確認

期待結果:
  - ファイル削除後に再アップロード可能
  - Snackbarで削除/追加通知が表示される
```

#### TC-006: ファイルダウンロード
```yaml
前提条件:
  - 処理完了状態

手順:
  1. 生成されたファイル一覧からExcelをクリック
  2. ダウンロードが開始されることを確認
  3. 注文書PDFをクリック
  4. ダウンロードが開始されることを確認
  5. 検収書PDFをクリック
  6. ダウンロードが開始されることを確認
  7. 「一括ダウンロード（ZIP）」ボタンをクリック
  8. ZIPファイルがダウンロードされることを確認

期待結果:
  - 各ファイルが正しいファイル名でダウンロードされる
  - ZIPファイル名: {取引先名}_{YYMM}.zip
```

---

### 2. 異常系テスト

#### TC-101: 取引先混在エラー
```yaml
前提条件:
  - ネクストビッツのPDF2つ + オフビートワークスのPDF2つ

手順:
  1. /process にアクセス
  2. 4つの混在PDFをドロップ

期待結果:
  - ダイアログで「異なる取引先のファイルが混在しています」エラー表示
  - ファイルは追加されない
```

#### TC-102: 個別追加時の取引先混在エラー
```yaml
前提条件:
  - ネクストビッツのPDF2つがアップロード済み

手順:
  1. オフビートワークスのPDFを納品書スロットに追加

期待結果:
  - ダイアログで取引先混在エラー表示
  - 既存ファイルは維持される
```

#### TC-103: 判別不可能なファイル名
```yaml
前提条件:
  - 判別キーワードを含まないPDF（例: document.pdf）

手順:
  1. /process にアクセス
  2. 判別不可能なPDFをドロップ

期待結果:
  - ダイアログで「取引先を判別できないファイルがあります」エラー表示
```

#### TC-104: 種別不一致エラー
```yaml
手順:
  1. 見積書スロットに請求書PDFを追加しようとする

期待結果:
  - ダイアログで「このファイルは「請求書」として判別されました。「見積書」のスロットには追加できません。」エラー表示
```

#### TC-105: PDF以外のファイル
```yaml
手順:
  1. /process にアクセス
  2. Excelファイルをドロップゾーンにドロップ

期待結果:
  - Snackbarで「PDFファイルを選択してください」エラー表示
```

#### TC-106: Excel以外のファイル（テンプレートアップロード）
```yaml
前提条件:
  - Excelアップロード画面が表示されている

手順:
  1. PDFファイルをExcelアップロードエリアにドロップ

期待結果:
  - Snackbarで「Excelファイルを選択してください」エラー表示
```

#### TC-107: Excelファイル名に取引先名がない
```yaml
前提条件:
  - ネクストビッツの処理中、Excelアップロード画面

手順:
  1. 取引先名を含まないExcel（例: template.xlsx）をアップロード

期待結果:
  - ダイアログで「ファイル名に取引先名が含まれていません」エラー表示
```

#### TC-108: Excelファイルの取引先不一致
```yaml
前提条件:
  - ネクストビッツの処理中、Excelアップロード画面

手順:
  1. オフビートワークスのExcelファイルをアップロード

期待結果:
  - ダイアログで「選択したファイルは「株式会社オフビートワークス」のファイルです」エラー表示
```

---

### 3. UI/UXテスト

#### TC-201: ドラッグ&ドロップオーバーレイ
```yaml
手順:
  1. /process にアクセス
  2. ファイルをドラッグしてカード上に移動（ドロップはしない）

期待結果:
  - 白色半透明オーバーレイ（85%）が表示される
  - 中央に「ここにドロップ」テキストとアイコンが表示される
```

#### TC-202: Excelテンプレート差し替え
```yaml
前提条件:
  - Excelテンプレートアップロード済み（ready状態）

手順:
  1. 別のExcelファイルをドラッグ&ドロップ

期待結果:
  - 新しいExcelファイルに差し替わる
  - Snackbar通知なし（静かに差し替え）
```

#### TC-203: 処理完了フェードインアニメーション
```yaml
手順:
  1. 処理を実行
  2. 処理完了を待つ

期待結果:
  - 「✅ 処理が完了しました」がフェードイン（0.6秒）で表示される
```

#### TC-204: プログレスバー表示
```yaml
手順:
  1. 「処理を実行」ボタンをクリック

期待結果:
  - プログレスバーが0%から100%まで段階的に増加
  - 各ステップでメッセージが更新される
    - "PDFを解析中..."
    - "見積書からデータを抽出中..."
    - "請求書からデータを抽出中..."
    - "注文請書からデータを抽出中..."
    - "納品書からデータを抽出中..."
    - "Excelを編集中..."
    - "PDFを生成中..."
    - "処理完了"
```

#### TC-205: 新規処理開始
```yaml
前提条件:
  - 処理完了状態

手順:
  1. 「新規処理を開始」ボタンをクリック

期待結果:
  - 初期状態（PDFドロップゾーン）に戻る
  - 前回の処理結果はクリアされる
```

---

### 4. レスポンシブテスト

#### TC-301: デスクトップ表示 (1920x1080)
```yaml
確認項目:
  - PDFスロットが2列で表示される
  - ボタンが横並びで表示される
```

#### TC-302: タブレット表示 (768x1024)
```yaml
確認項目:
  - PDFスロットが2列で表示される
  - レイアウトが適切にリフロー
```

#### TC-303: モバイル表示 (375x667)
```yaml
確認項目:
  - PDFスロットが1列で表示される
  - ボタンが縦並びになる
  - ドラッグ&ドロップが機能する
```

---

### 5. セキュリティテスト

#### TC-401: 未認証アクセス
```yaml
手順:
  1. ログアウト状態で /process にアクセス

期待結果:
  - /login にリダイレクトされる
```

#### TC-402: ファイルサイズ制限
```yaml
手順:
  1. 10MBを超えるPDFファイルをアップロード

期待結果:
  - エラーメッセージ「ファイルサイズが10MBを超えています」が表示される
```

---

## 📁 テストデータ

### ネクストビッツ用テストファイル
| ファイル名 | 種別 |
|-----------|------|
| TRR-25-011_お見積書.pdf | 見積書 |
| TRR-25-011_請求書.pdf | 請求書 |
| TRR-25-011_注文請書.pdf | 注文請書 |
| TRR-25-011_納品書.pdf | 納品書 |
| テラ【株式会社ネクストビッツ御中】注文検収書_2511.xlsx | テンプレート |

### オフビートワークス用テストファイル
| ファイル名 | 種別 |
|-----------|------|
| 1951030見積-offbeat-to-terra-202511.pdf | 見積書 |
| 2951030-請求_offbeat-to-terra-202511.pdf | 請求書 |
| 請書-offbeat-to-terra-202511.pdf | 注文請書 |
| 3951030-納品-offbeat-to-terra-202511.pdf | 納品書 |

### テストデータ配置場所
```
/home/iwafune-hiroko/seikyu-henkan-2/source/ネクストビッツ/
/home/iwafune-hiroko/seikyu-henkan-2/source/オフビートワークス/（要作成）
```

---

## 🔗 関連ドキュメント

| ドキュメント | パス |
|-------------|------|
| API仕様書 | `docs/api-specs/process-api.md` |
| 要件定義書 | `docs/requirements.md` (P-002セクション) |
| モックサービス | `frontend/src/services/mock/processService.ts` |
