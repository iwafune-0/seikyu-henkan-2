# 認証E2Eテスト仕様書 (P-001)

**生成日**: 2025-10-08
**対象ページ**: P-001a (ログイン), P-001b (招待受諾), P-001c (パスワードリセット)
**テストツール**: Playwright

---

## 📋 概要

P-001認証ページ群のE2Eテスト仕様を定義します。正常系・異常系・セキュリティ・レスポンシブの全観点から網羅的にテストします。

---

## 🧪 テストケース一覧

### P-001a: ログインページ

#### 正常系

##### TC-001a-N01: ログイン成功（管理者）
```yaml
前提条件:
  - ログアウト状態
  - モック環境（admin@example.com が存在）

テスト手順:
  1. /login にアクセス
  2. メールアドレスに "admin@example.com" を入力
  3. パスワードに "password123" を入力
  4. [ログイン] ボタンをクリック

期待結果:
  - /process にリダイレクト
  - サイドバーに "ユーザー管理" が表示される（管理者のみ）
  - UserMenuに "admin@example.com" が表示される
  - UserMenuに "管理者" バッジが表示される
```

##### TC-001a-N02: ログイン成功（一般ユーザー）
```yaml
前提条件:
  - ログアウト状態
  - モック環境（user@example.com が存在）

テスト手順:
  1. /login にアクセス
  2. メールアドレスに "user@example.com" を入力
  3. パスワードに "password123" を入力
  4. [ログイン] ボタンをクリック

期待結果:
  - /process にリダイレクト
  - サイドバーに "ユーザー管理" が表示されない
  - UserMenuに "user@example.com" が表示される
  - UserMenuに "一般ユーザー" バッジが表示される
```

##### TC-001a-N03: ログイン状態保持（チェックON - localStorage）
```yaml
前提条件:
  - ログアウト状態
  - localStorage と sessionStorage をクリア

テスト手順:
  1. /login にアクセス
  2. メールアドレスに "admin@example.com" を入力
  3. パスワードに "password123" を入力
  4. "ログイン状態を保持する" にチェック ☑️
  5. [ログイン] ボタンをクリック
  6. localStorage に "auth-storage" が保存されているか確認
  7. タブを閉じる
  8. 新しいタブで / にアクセス

期待結果:
  - localStorage に認証情報が保存される
  - タブを閉じても認証情報が保持される
  - /process に自動的にリダイレクト
```

##### TC-001a-N04: ログイン状態非保持（チェックOFF - sessionStorage）
```yaml
前提条件:
  - ログアウト状態
  - localStorage と sessionStorage をクリア

テスト手順:
  1. /login にアクセス
  2. メールアドレスに "admin@example.com" を入力
  3. パスワードに "password123" を入力
  4. "ログイン状態を保持する" のチェックを外す（デフォルト） ☐
  5. [ログイン] ボタンをクリック
  6. sessionStorage に "auth-storage" が保存されているか確認
  7. タブを閉じる
  8. 新しいタブで / にアクセス

期待結果:
  - sessionStorage に認証情報が保存される
  - タブを閉じると認証情報が削除される
  - /login にリダイレクト（ログイン画面が表示）
```

##### TC-001a-N05: パスワードリセットページへ遷移
```yaml
前提条件:
  - ログアウト状態

テスト手順:
  1. /login にアクセス
  2. "パスワードをお忘れですか？" リンクをクリック

期待結果:
  - /reset-password にリダイレクト
```

---

#### 異常系

##### TC-001a-E01: メールアドレス未入力
```yaml
前提条件:
  - ログアウト状態

テスト手順:
  1. /login にアクセス
  2. メールアドレスを空のまま
  3. パスワードに "password123" を入力
  4. [ログイン] ボタンをクリック

期待結果:
  - エラーメッセージ "メールアドレスを入力してください。" が表示される
  - ページ遷移しない
  - メールアドレスフィールドに aria-invalid="true" が設定される
```

##### TC-001a-E02: メールアドレス形式不正
```yaml
前提条件:
  - ログアウト状態

テスト手順:
  1. /login にアクセス
  2. メールアドレスに "invalidemail" を入力（@なし）
  3. パスワードに "password123" を入力
  4. [ログイン] ボタンをクリック

期待結果:
  - エラーメッセージ "有効なメールアドレスを入力してください。" が表示される
  - ページ遷移しない
```

##### TC-001a-E03: パスワード未入力
```yaml
前提条件:
  - ログアウト状態

テスト手順:
  1. /login にアクセス
  2. メールアドレスに "admin@example.com" を入力
  3. パスワードを空のまま
  4. [ログイン] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードを入力してください。" が表示される
  - ページ遷移しない
```

##### TC-001a-E04: 認証失敗（ユーザー不存在）
```yaml
前提条件:
  - ログアウト状態
  - モック環境

テスト手順:
  1. /login にアクセス
  2. メールアドレスに "notexist@example.com" を入力
  3. パスワードに "password123" を入力
  4. [ログイン] ボタンをクリック

期待結果:
  - エラーメッセージ "ユーザーが見つかりません" が表示される
  - ページ遷移しない
```

##### TC-001a-E05: パスワード長さ不足
```yaml
前提条件:
  - ログアウト状態

テスト手順:
  1. /login にアクセス
  2. メールアドレスに "admin@example.com" を入力
  3. パスワードに "pass" を入力（8文字未満）
  4. [ログイン] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードは8文字以上で入力してください" が表示される
  - ページ遷移しない
```

---

### P-001b: 招待受諾・パスワード設定ページ

#### 正常系

##### TC-001b-N01: パスワード設定成功
```yaml
前提条件:
  - ログアウト状態
  - 招待トークンあり

テスト手順:
  1. /accept-invitation?token=valid-token&email=newuser@example.com にアクセス
  2. メールアドレスに "newuser@example.com" が自動表示されることを確認
  3. パスワードに "password123" を入力
  4. パスワード（確認）に "password123" を入力
  5. [パスワードを設定] ボタンをクリック

期待結果:
  - /login にリダイレクト
  - 成功メッセージ "パスワードが設定されました。\nログインしてください。" が表示される
  - メッセージが改行されて表示される
```

---

#### 異常系

##### TC-001b-E01: トークン不正
```yaml
前提条件:
  - ログアウト状態

テスト手順:
  1. /accept-invitation にアクセス（tokenなし）

期待結果:
  - エラーメッセージ "無効な招待リンクです。" が表示される
```

##### TC-001b-E02: パスワード未入力
```yaml
前提条件:
  - /accept-invitation?token=valid-token&email=newuser@example.com にアクセス

テスト手順:
  1. パスワードを空のまま
  2. [パスワードを設定] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードを入力してください。" が表示される
```

##### TC-001b-E03: パスワード長さ不足
```yaml
前提条件:
  - /accept-invitation?token=valid-token&email=newuser@example.com にアクセス

テスト手順:
  1. パスワードに "pass" を入力（8文字未満）
  2. パスワード（確認）に "pass" を入力
  3. [パスワードを設定] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードは8文字以上で入力してください。" が表示される
```

##### TC-001b-E04: パスワードに英字なし
```yaml
前提条件:
  - /accept-invitation?token=valid-token&email=newuser@example.com にアクセス

テスト手順:
  1. パスワードに "12345678" を入力（数字のみ）
  2. パスワード（確認）に "12345678" を入力
  3. [パスワードを設定] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードには英字を含めてください。" が表示される
```

##### TC-001b-E05: パスワードに数字なし
```yaml
前提条件:
  - /accept-invitation?token=valid-token&email=newuser@example.com にアクセス

テスト手順:
  1. パスワードに "password" を入力（英字のみ）
  2. パスワード（確認）に "password" を入力
  3. [パスワードを設定] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードには数字を含めてください。" が表示される
```

##### TC-001b-E06: パスワードに記号あり
```yaml
前提条件:
  - /accept-invitation?token=valid-token&email=newuser@example.com にアクセス

テスト手順:
  1. パスワードに "password123!" を入力（記号含む）
  2. パスワード（確認）に "password123!" を入力
  3. [パスワードを設定] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードは半角の英字・数字のみで入力してください。" が表示される
```

##### TC-001b-E07: パスワード確認未入力
```yaml
前提条件:
  - /accept-invitation?token=valid-token&email=newuser@example.com にアクセス

テスト手順:
  1. パスワードに "password123" を入力
  2. パスワード（確認）を空のまま
  3. [パスワードを設定] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワード（確認）を入力してください。" が表示される
```

##### TC-001b-E08: パスワード不一致
```yaml
前提条件:
  - /accept-invitation?token=valid-token&email=newuser@example.com にアクセス

テスト手順:
  1. パスワードに "password123" を入力
  2. パスワード（確認）に "password456" を入力
  3. [パスワードを設定] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードが一致しません。" が表示される
```

---

### P-001c: パスワードリセットページ

#### 正常系

##### TC-001c-N01: パスワードリセットメール送信成功
```yaml
前提条件:
  - ログアウト状態
  - モック環境

テスト手順:
  1. /reset-password にアクセス
  2. メールアドレスに "admin@example.com" を入力
  3. [リセットリンクを送信] ボタンをクリック

期待結果:
  - 成功メッセージ "パスワードリセットのメールを送信しました。メールをご確認ください。" が表示される
  - ページ遷移しない
```

##### TC-001c-N02: 新パスワード設定成功
```yaml
前提条件:
  - ログアウト状態
  - リセットトークンあり

テスト手順:
  1. /reset-password?step=password にアクセス
  2. 新パスワードに "newpassword123" を入力
  3. パスワード（確認）に "newpassword123" を入力
  4. [パスワードを変更] ボタンをクリック

期待結果:
  - /login にリダイレクト
  - 成功メッセージ "パスワードがリセットされました。\n新しいパスワードでログインしてください。" が表示される
  - メッセージが改行されて表示される
```

##### TC-001c-N03: ログインページに戻る
```yaml
前提条件:
  - /reset-password にアクセス（step=email）

テスト手順:
  1. "ログインページに戻る" ボタンをクリック

期待結果:
  - /login にリダイレクト
```

---

#### 異常系

##### TC-001c-E01: メールアドレス未入力
```yaml
前提条件:
  - /reset-password にアクセス

テスト手順:
  1. メールアドレスを空のまま
  2. [リセットリンクを送信] ボタンをクリック

期待結果:
  - エラーメッセージ "メールアドレスを入力してください。" が表示される
```

##### TC-001c-E02: メールアドレス形式不正
```yaml
前提条件:
  - /reset-password にアクセス

テスト手順:
  1. メールアドレスに "invalidemail" を入力（@なし）
  2. [リセットリンクを送信] ボタンをクリック

期待結果:
  - エラーメッセージ "有効なメールアドレスを入力してください。" が表示される
```

##### TC-001c-E03: 新パスワード未入力
```yaml
前提条件:
  - /reset-password?step=password にアクセス

テスト手順:
  1. 新パスワードを空のまま
  2. [パスワードを変更] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードを入力してください。" が表示される
```

##### TC-001c-E04: 新パスワード長さ不足
```yaml
前提条件:
  - /reset-password?step=password にアクセス

テスト手順:
  1. 新パスワードに "pass" を入力（8文字未満）
  2. パスワード（確認）に "pass" を入力
  3. [パスワードを変更] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードは8文字以上で入力してください。" が表示される
```

##### TC-001c-E05: 新パスワードに英字なし
```yaml
前提条件:
  - /reset-password?step=password にアクセス

テスト手順:
  1. 新パスワードに "12345678" を入力（数字のみ）
  2. パスワード（確認）に "12345678" を入力
  3. [パスワードを変更] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードには英字を含めてください。" が表示される
```

##### TC-001c-E06: 新パスワードに数字なし
```yaml
前提条件:
  - /reset-password?step=password にアクセス

テスト手順:
  1. 新パスワードに "password" を入力（英字のみ）
  2. パスワード（確認）に "password" を入力
  3. [パスワードを変更] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードには数字を含めてください。" が表示される
```

##### TC-001c-E07: 新パスワードに記号あり
```yaml
前提条件:
  - /reset-password?step=password にアクセス

テスト手順:
  1. 新パスワードに "password123!" を入力（記号含む）
  2. パスワード（確認）に "password123!" を入力
  3. [パスワードを変更] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードは半角の英字・数字のみで入力してください。" が表示される
```

##### TC-001c-E08: パスワード確認未入力
```yaml
前提条件:
  - /reset-password?step=password にアクセス

テスト手順:
  1. 新パスワードに "newpassword123" を入力
  2. パスワード（確認）を空のまま
  3. [パスワードを変更] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワード（確認）を入力してください。" が表示される
```

##### TC-001c-E09: パスワード不一致
```yaml
前提条件:
  - /reset-password?step=password にアクセス

テスト手順:
  1. 新パスワードに "newpassword123" を入力
  2. パスワード（確認）に "newpassword456" を入力
  3. [パスワードを変更] ボタンをクリック

期待結果:
  - エラーメッセージ "パスワードが一致しません。" が表示される
```

---

## 📱 レスポンシブテスト

### TC-RESP-01: モバイル表示（375px）
```yaml
テスト手順:
  1. ビューポートを 375x667 に設定
  2. P-001a/b/c 各ページにアクセス
  3. 全ての要素が正しく表示されることを確認

期待結果:
  - padding: 16px（p-4）が適用される
  - フォントサイズ: text-xl が適用される
  - 全てのボタンがタップ可能（最小44x44px）
  - テキストが画面に収まる
  - スクロール可能
```

### TC-RESP-02: タブレット表示（768px）
```yaml
テスト手順:
  1. ビューポートを 768x1024 に設定
  2. P-001a/b/c 各ページにアクセス
  3. 全ての要素が正しく表示されることを確認

期待結果:
  - padding: 32px（sm:p-8）が適用される
  - フォントサイズ: sm:text-2xl が適用される
  - レイアウトが適切
```

### TC-RESP-03: デスクトップ表示（1920px）
```yaml
テスト手順:
  1. ビューポートを 1920x1080 に設定
  2. P-001a/b/c 各ページにアクセス
  3. 全ての要素が正しく表示されることを確認

期待結果:
  - max-w-md（448px）でコンテンツが中央寄せ
  - 左右に余白が十分ある
```

---

## ♿ アクセシビリティテスト

### TC-A11Y-01: aria属性の確認
```yaml
テスト手順:
  1. P-001a にアクセス
  2. バリデーションエラーを発生させる
  3. input要素を検証

期待結果:
  - aria-invalid="true" が設定される
  - aria-describedby が正しいエラーIDを参照
  - エラーメッセージに role="alert" が設定される
```

### TC-A11Y-02: スクリーンリーダー対応
```yaml
テスト手順:
  1. スクリーンリーダーを起動
  2. P-001a/b/c 各ページを操作
  3. 音声読み上げを確認

期待結果:
  - 全てのフォームフィールドがラベルと関連付けられている
  - エラーメッセージが読み上げられる
  - ボタンの役割が明確
```

### TC-A11Y-03: キーボードナビゲーション
```yaml
テスト手順:
  1. P-001a にアクセス
  2. Tabキーで全フィールドを移動
  3. Enterキーでフォーム送信

期待結果:
  - Tab順序が論理的
  - フォーカスインジケータが表示される
  - Enterキーでログイン可能
```

---

## 🔒 セキュリティテスト

### TC-SEC-01: パスワードマスキング
```yaml
テスト手順:
  1. P-001a にアクセス
  2. パスワードフィールドに "password123" を入力
  3. DOM要素を検証

期待結果:
  - type="password" が設定されている
  - 入力内容が "●●●●●●●●●●●" と表示される
  - value属性には実際のパスワードが含まれる（通常動作）
```

### TC-SEC-02: localStorage保存確認
```yaml
テスト手順:
  1. P-001a でログイン
  2. DevToolsでlocalStorageを確認

期待結果:
  - "auth-storage" キーにユーザー情報が保存される
  - パスワードは保存されない
  - トークン情報のみ保存
```

### TC-SEC-03: 認証状態の確認
```yaml
テスト手順:
  1. ログイン前に /process にアクセス

期待結果:
  - /login にリダイレクト
  - 認証なしではアクセス不可
```

---

## 📊 テスト実行計画

### Phase 9（E2Eテスト）で実施
```
1. Playwright環境構築
2. モック環境でテスト実行
3. 全テストケース実施（正常系・異常系）
4. レスポンシブテスト実施
5. アクセシビリティテスト実施
6. セキュリティテスト実施
7. テスト結果レポート作成
```

### テストカバレッジ目標
- 正常系: 100%
- 異常系: 100%
- レスポンシブ: 3サイズ（モバイル・タブレット・デスクトップ）
- アクセシビリティ: WCAG 2.1 Level AA準拠

---

## 🔗 関連ファイル

| ファイル | 役割 |
|---------|------|
| `frontend/src/pages/auth/LoginPage.tsx` | P-001a実装 |
| `frontend/src/pages/auth/AcceptInvitationPage.tsx` | P-001b実装 |
| `frontend/src/pages/auth/ResetPasswordPage.tsx` | P-001c実装 |
| `docs/api-specs/auth-api.md` | API仕様書 |

---

**作成日**: 2025-10-08
**最終更新**: 2025-12-04
**バージョン**: 1.2
**Phase**: 4-B (P-001ドキュメント補完)
**テストケース総数**: 40+

---

## 📝 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-04 | 1.2 | P-001c UI改善反映<br>- 「ログインページに戻る」ボタンのスタイル改善（text-primary hover:underline）に対応 |
| 2025-10-08 | 1.1 | TC-001a-N03/N04を追加・詳細化<br>- ログイン状態保持機能のテストケースを2つに分割（localStorage/sessionStorage） |
| 2025-10-08 | 1.0 | 初版作成 |
